{#
Portal Drawings Page
Request and track custom drawings and technical documentation
#}
{% extends "templates/web.html" %}

{% block title %}{{ _("Drawing Requests") }}{% endblock %}

{% block style %}
<style>
.portal-page {
	padding: 2rem 0;
}
.page-header {
	margin-bottom: 2rem;
}
.request-card {
	background: white;
	border-radius: 12px;
	box-shadow: 0 2px 8px rgba(0,0,0,0.06);
	margin-bottom: 1rem;
	overflow: hidden;
}
.request-header {
	display: flex;
	justify-content: space-between;
	align-items: center;
	padding: 1rem 1.5rem;
	border-bottom: 1px solid #f0f0f0;
}
.request-title {
	font-weight: 600;
	color: #333;
}
.request-body {
	padding: 1.25rem 1.5rem;
}
.request-meta {
	display: flex;
	gap: 2rem;
	flex-wrap: wrap;
	font-size: 0.9rem;
	color: #666;
}
.request-meta i {
	margin-right: 0.5rem;
	color: #999;
}
.request-footer {
	padding: 1rem 1.5rem;
	background: #fafbfc;
	border-top: 1px solid #f0f0f0;
	display: flex;
	justify-content: space-between;
	align-items: center;
}
.form-card {
	background: white;
	border-radius: 12px;
	box-shadow: 0 2px 12px rgba(0,0,0,0.08);
	overflow: hidden;
}
.form-card-header {
	padding: 1.5rem;
	background: linear-gradient(135deg, #f57c00 0%, #ff9800 100%);
	color: white;
}
.form-card-header h5 {
	margin: 0;
	font-weight: 600;
}
.form-card-body {
	padding: 1.5rem;
}
.drawing-type-selector {
	display: grid;
	grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
	gap: 0.75rem;
	margin-bottom: 1.5rem;
}
.drawing-type-option {
	padding: 1rem;
	border: 2px solid #e0e0e0;
	border-radius: 8px;
	text-align: center;
	cursor: pointer;
	transition: all 0.2s;
}
.drawing-type-option:hover {
	border-color: #f57c00;
}
.drawing-type-option.selected {
	border-color: #f57c00;
	background: #fff3e0;
}
.drawing-type-option i {
	font-size: 1.5rem;
	display: block;
	margin-bottom: 0.5rem;
	color: #f57c00;
}
.drawing-type-option span {
	font-size: 0.85rem;
	font-weight: 500;
}
.section-divider {
	display: flex;
	align-items: center;
	margin: 2rem 0;
}
.section-divider::before,
.section-divider::after {
	content: '';
	flex: 1;
	height: 1px;
	background: #e0e0e0;
}
.section-divider span {
	padding: 0 1rem;
	color: #888;
	font-size: 0.9rem;
}
.status-badge {
	padding: 0.25rem 0.75rem;
	border-radius: 20px;
	font-size: 0.8rem;
	font-weight: 500;
}
.status-badge.pending { background: #fff3e0; color: #ef6c00; }
.status-badge.in-progress { background: #e3f2fd; color: #1565c2; }
.status-badge.completed { background: #e8f5e9; color: #2e7d32; }
.status-badge.cancelled { background: #ffebee; color: #c62828; }
.empty-state {
	text-align: center;
	padding: 3rem 2rem;
	background: #fafbfc;
	border-radius: 8px;
}
.empty-state i {
	font-size: 3rem;
	color: #ccc;
	margin-bottom: 1rem;
}
.tab-content {
	padding-top: 1.5rem;
}
</style>
{% endblock %}

{% block page_content %}
<div class="container portal-page">
	<!-- Breadcrumb -->
	<nav aria-label="breadcrumb" class="mb-3">
		<ol class="breadcrumb">
			<li class="breadcrumb-item"><a href="/portal">{{ _("Portal") }}</a></li>
			<li class="breadcrumb-item active">{{ _("Drawings") }}</li>
		</ol>
	</nav>

	<!-- Page Header -->
	<div class="page-header">
		<h1>{{ _("Drawing Requests") }}</h1>
		<p class="text-muted">{{ _("Request custom drawings and track their status") }}</p>
	</div>

	<div class="row">
		<!-- New Request Form -->
		<div class="col-lg-5 mb-4">
			<div class="form-card">
				<div class="form-card-header">
					<h5><i class="fa fa-pencil-square-o"></i> {{ _("Request New Drawing") }}</h5>
				</div>
				<div class="form-card-body">
					<form id="drawingRequestForm">
						<!-- Drawing Type Selection -->
						<label class="mb-2">{{ _("Drawing Type") }}</label>
						<div class="drawing-type-selector">
							<div class="drawing-type-option selected" data-value="shop_drawing">
								<i class="fa fa-wrench"></i>
								<span>{{ _("Shop Drawing") }}</span>
							</div>
							<div class="drawing-type-option" data-value="spec_sheet">
								<i class="fa fa-file-text-o"></i>
								<span>{{ _("Spec Sheet") }}</span>
							</div>
							<div class="drawing-type-option" data-value="installation">
								<i class="fa fa-puzzle-piece"></i>
								<span>{{ _("Installation") }}</span>
							</div>
							<div class="drawing-type-option" data-value="ies_file">
								<i class="fa fa-lightbulb-o"></i>
								<span>{{ _("IES File") }}</span>
							</div>
						</div>
						<input type="hidden" name="drawing_type" value="shop_drawing">

						<div class="form-group">
							<label>{{ _("Project / Reference") }} <span class="text-danger">*</span></label>
							<select class="form-control" name="project" required>
								<option value="">{{ _("Select project...") }}</option>
								{% for project in projects %}
								<option value="{{ project.name }}">{{ project.project_name }}</option>
								{% endfor %}
								<option value="_custom">{{ _("Other (specify below)") }}</option>
							</select>
						</div>

						<div class="form-group" id="customRefGroup" style="display: none;">
							<label>{{ _("Custom Reference") }}</label>
							<input type="text" class="form-control" name="custom_reference" placeholder="{{ _('Project name, quote number, etc.') }}">
						</div>

						<div class="form-group">
							<label>{{ _("Fixture / Product") }}</label>
							<input type="text" class="form-control" name="fixture_reference" placeholder="{{ _('e.g., LS-48 Linear, Quote #12345') }}">
						</div>

						<div class="form-group">
							<label>{{ _("Description") }} <span class="text-danger">*</span></label>
							<textarea class="form-control" name="description" rows="4" required placeholder="{{ _('Please describe what you need. Include dimensions, mounting details, or any specific requirements.') }}"></textarea>
						</div>

						<div class="form-group">
							<label>{{ _("Priority") }}</label>
							<select class="form-control" name="priority">
								<option value="normal">{{ _("Normal") }}</option>
								<option value="high">{{ _("High - Needed within 2 business days") }}</option>
								<option value="rush">{{ _("Rush - Needed within 24 hours") }}</option>
							</select>
						</div>

						<div class="form-group">
							<label>{{ _("Attachments") }}</label>
							<input type="file" class="form-control-file" name="attachments" multiple>
							<small class="form-text text-muted">{{ _("Upload reference files, markups, or existing drawings") }}</small>
						</div>

						<hr>
						<button type="submit" class="btn btn-warning btn-block">
							<i class="fa fa-paper-plane"></i> {{ _("Submit Request") }}
						</button>
					</form>
				</div>
			</div>
		</div>

		<!-- Request History -->
		<div class="col-lg-7">
			<ul class="nav nav-tabs" role="tablist">
				<li class="nav-item">
					<a class="nav-link active" data-toggle="tab" href="#pending">
						{{ _("Pending") }} 
						{% if pending_count > 0 %}<span class="badge badge-warning">{{ pending_count }}</span>{% endif %}
					</a>
				</li>
				<li class="nav-item">
					<a class="nav-link" data-toggle="tab" href="#completed">{{ _("Completed") }}</a>
				</li>
				<li class="nav-item">
					<a class="nav-link" data-toggle="tab" href="#all">{{ _("All Requests") }}</a>
				</li>
			</ul>

			<div class="tab-content">
				<!-- Pending Tab -->
				<div class="tab-pane fade show active" id="pending">
					{% if pending_requests %}
					{% for req in pending_requests %}
					<div class="request-card">
						<div class="request-header">
							<span class="request-title">
								<i class="fa fa-{{ drawing_type_icon(req.drawing_type) }}"></i>
								{{ req.drawing_type_display or req.drawing_type }}
							</span>
							<span class="status-badge {{ req.status | lower | replace(' ', '-') }}">
								{{ req.status }}
							</span>
						</div>
						<div class="request-body">
							<p class="mb-2">{{ req.description | truncate(150) }}</p>
							<div class="request-meta">
								<span><i class="fa fa-folder"></i> {{ req.project_name or req.custom_reference or "-" }}</span>
								<span><i class="fa fa-calendar"></i> {{ frappe.utils.format_date(req.creation) }}</span>
								{% if req.priority != "normal" %}
								<span class="text-{{ 'danger' if req.priority == 'rush' else 'warning' }}">
									<i class="fa fa-flag"></i> {{ req.priority | title }}
								</span>
								{% endif %}
							</div>
						</div>
						<div class="request-footer">
							<small class="text-muted">{{ _("Request") }} #{{ req.name }}</small>
							<a href="/portal/drawings/{{ req.name }}" class="btn btn-sm btn-outline-primary">
								{{ _("View Details") }}
							</a>
						</div>
					</div>
					{% endfor %}
					{% else %}
					<div class="empty-state">
						<i class="fa fa-check-circle"></i>
						<h5>{{ _("No pending requests") }}</h5>
						<p class="text-muted">{{ _("All your drawing requests have been completed!") }}</p>
					</div>
					{% endif %}
				</div>

				<!-- Completed Tab -->
				<div class="tab-pane fade" id="completed">
					{% if completed_requests %}
					{% for req in completed_requests %}
					<div class="request-card">
						<div class="request-header">
							<span class="request-title">
								<i class="fa fa-{{ drawing_type_icon(req.drawing_type) }}"></i>
								{{ req.drawing_type_display or req.drawing_type }}
							</span>
							<span class="status-badge completed">{{ _("Completed") }}</span>
						</div>
						<div class="request-body">
							<p class="mb-2">{{ req.description | truncate(150) }}</p>
							<div class="request-meta">
								<span><i class="fa fa-folder"></i> {{ req.project_name or req.custom_reference or "-" }}</span>
								<span><i class="fa fa-calendar"></i> {{ frappe.utils.format_date(req.completed_date or req.modified) }}</span>
							</div>
						</div>
						<div class="request-footer">
							<small class="text-muted">{{ _("Request") }} #{{ req.name }}</small>
							<div>
								{% if req.has_attachments %}
								<a href="/portal/drawings/{{ req.name }}" class="btn btn-sm btn-success">
									<i class="fa fa-download"></i> {{ _("Download") }}
								</a>
								{% endif %}
								<a href="/portal/drawings/{{ req.name }}" class="btn btn-sm btn-outline-primary">
									{{ _("View") }}
								</a>
							</div>
						</div>
					</div>
					{% endfor %}
					{% else %}
					<div class="empty-state">
						<i class="fa fa-file-pdf-o"></i>
						<h5>{{ _("No completed requests yet") }}</h5>
						<p class="text-muted">{{ _("Completed drawings will appear here for download.") }}</p>
					</div>
					{% endif %}
				</div>

				<!-- All Tab -->
				<div class="tab-pane fade" id="all">
					{% if all_requests %}
					{% for req in all_requests %}
					<div class="request-card">
						<div class="request-header">
							<span class="request-title">
								<i class="fa fa-{{ drawing_type_icon(req.drawing_type) }}"></i>
								{{ req.drawing_type_display or req.drawing_type }}
							</span>
							<span class="status-badge {{ req.status | lower | replace(' ', '-') }}">
								{{ req.status }}
							</span>
						</div>
						<div class="request-body">
							<p class="mb-2">{{ req.description | truncate(100) }}</p>
							<div class="request-meta">
								<span><i class="fa fa-folder"></i> {{ req.project_name or "-" }}</span>
								<span><i class="fa fa-calendar"></i> {{ frappe.utils.format_date(req.creation) }}</span>
							</div>
						</div>
						<div class="request-footer">
							<small class="text-muted">#{{ req.name }}</small>
							<a href="/portal/drawings/{{ req.name }}" class="btn btn-sm btn-outline-primary">{{ _("View") }}</a>
						</div>
					</div>
					{% endfor %}
					{% else %}
					<div class="empty-state">
						<i class="fa fa-file-o"></i>
						<h5>{{ _("No drawing requests yet") }}</h5>
						<p class="text-muted">{{ _("Submit your first request using the form.") }}</p>
					</div>
					{% endif %}
				</div>
			</div>
		</div>
	</div>
</div>
{% endblock %}

{% block script %}
<script>
document.addEventListener('DOMContentLoaded', function() {
	// Drawing type selector
	const typeOptions = document.querySelectorAll('.drawing-type-option');
	const typeInput = document.querySelector('input[name="drawing_type"]');

	typeOptions.forEach(option => {
		option.addEventListener('click', function() {
			typeOptions.forEach(o => o.classList.remove('selected'));
			this.classList.add('selected');
			typeInput.value = this.dataset.value;
		});
	});

	// Show/hide custom reference field
	const projectSelect = document.querySelector('select[name="project"]');
	const customRefGroup = document.getElementById('customRefGroup');

	projectSelect.addEventListener('change', function() {
		customRefGroup.style.display = this.value === '_custom' ? 'block' : 'none';
	});

	// Form submission
	const form = document.getElementById('drawingRequestForm');
	form.addEventListener('submit', function(e) {
		e.preventDefault();

		const formData = new FormData(form);
		const data = Object.fromEntries(formData.entries());

		// Handle custom project reference
		if (data.project === '_custom') {
			data.project = null;
		}

		frappe.call({
			method: 'illumenate_lighting.illumenate_lighting.api.portal.create_drawing_request',
			args: { request_data: JSON.stringify(data) },
			freeze: true,
			freeze_message: '{{ _("Submitting request...") }}',
			callback: function(r) {
				if (r.message && r.message.success) {
					frappe.msgprint({
						title: '{{ _("Request Submitted") }}',
						indicator: 'green',
						message: '{{ _("Your drawing request has been submitted. We will notify you when it is ready.") }}'
					});
					form.reset();
					setTimeout(() => location.reload(), 2000);
				} else {
					frappe.msgprint({
						title: '{{ _("Error") }}',
						indicator: 'red',
						message: r.message?.error || '{{ _("An error occurred") }}'
					});
				}
			}
		});
	});
});
</script>
{% endblock %}
