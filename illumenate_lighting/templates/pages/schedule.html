{#
Portal Schedule Detail Page
Displays a fixture schedule with its lines and configurator actions
Also handles new schedule creation when is_new is True
#}
{% extends "templates/web.html" %}

{% block title %}{% if is_new %}{{ _("Create Schedule") }}{% else %}{{ schedule.schedule_name }}{% endif %}{% endblock %}

{% block style %}
<style>
.action-buttons .btn {
	margin-left: 2px;
	margin-right: 2px;
}
.action-buttons .btn i {
	pointer-events: none;
}
</style>
{% endblock %}

{% block page_content %}
<div class="container portal-page">
	<!-- Breadcrumb -->
	<nav aria-label="breadcrumb" class="mb-4">
		<ol class="breadcrumb">
			<li class="breadcrumb-item"><a href="/portal/projects">{{ _("Projects") }}</a></li>
			<li class="breadcrumb-item"><a href="/portal/projects/{{ project.name }}">{{ project.project_name }}</a></li>
			<li class="breadcrumb-item active" aria-current="page">{% if is_new %}{{ _("Create Schedule") }}{% else %}{{ schedule.schedule_name }}{% endif %}</li>
		</ol>
	</nav>

	{% if is_new %}
	<!-- New Schedule Form -->
	<div class="row">
		<div class="col-lg-6">
			<div class="card">
				<div class="card-header">
					<h5 class="mb-0">{{ _("Create New Fixture Schedule") }}</h5>
				</div>
				<div class="card-body">
					<form id="createScheduleForm">
						<input type="hidden" name="ill_project" value="{{ project.name }}">
						<div class="form-group">
							<label>{{ _("Schedule Name") }} <span class="text-danger">*</span></label>
							<input type="text" class="form-control" name="schedule_name" required placeholder="{{ _('e.g., Area A - Linear Fixtures') }}">
						</div>
						<div class="form-group">
							<label>{{ _("Project") }}</label>
							<input type="text" class="form-control" value="{{ project.project_name }}" readonly>
						</div>
						<div class="form-group">
							<label>{{ _("Notes") }}</label>
							<textarea class="form-control" name="notes" rows="3" placeholder="{{ _('Optional notes about this schedule') }}"></textarea>
						</div>
						<hr>
						<div class="d-flex justify-content-between">
							<a href="/portal/projects/{{ project.name }}" class="btn btn-secondary">
								<i class="fa fa-arrow-left"></i> {{ _("Cancel") }}
							</a>
							<button type="submit" class="btn btn-primary">
								<i class="fa fa-plus"></i> {{ _("Create Schedule") }}
							</button>
						</div>
					</form>
				</div>
			</div>
		</div>
	</div>
	{% else %}

	<!-- Schedule Header -->
	<div class="row mb-4">
		<div class="col-12">
			<div class="card">
				<div class="card-body">
					<div class="d-flex justify-content-between align-items-start">
						<div>
							<h1 class="mb-2">{{ schedule.schedule_name }}</h1>
							<p class="text-muted mb-2">
								<strong>{{ _("Project") }}:</strong> {{ project.project_name }}
							</p>
							<div class="d-flex align-items-center gap-2">
								<span class="badge badge-{{ schedule_status_class(schedule.status) }}" id="statusBadge">
									{{ schedule.status }}
								</span>
								{% if can_edit and schedule.status not in ['ORDERED', 'CLOSED'] %}
								<div class="dropdown d-inline-block ml-2">
									<button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="statusDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
										<i class="fa fa-exchange"></i> {{ _("Change Status") }}
									</button>
									<div class="dropdown-menu" aria-labelledby="statusDropdown">
										{% if schedule.status != 'DRAFT' %}
										<a class="dropdown-item" href="#" onclick="changeStatus('DRAFT'); return false;">
											<i class="fa fa-pencil text-warning"></i> {{ _("DRAFT") }}
											<small class="text-muted d-block">{{ _("Continue editing") }}</small>
										</a>
										{% endif %}
										{% if schedule.status != 'READY' %}
										<a class="dropdown-item" href="#" onclick="changeStatus('READY'); return false;">
											<i class="fa fa-check-circle text-info"></i> {{ _("READY") }}
											<small class="text-muted d-block">{{ _("Ready for quote/order") }}</small>
										</a>
										{% endif %}
										{% if (is_dealer or is_internal) and schedule.status != 'QUOTED' %}
										<a class="dropdown-item" href="#" onclick="changeStatus('QUOTED'); return false;">
											<i class="fa fa-file-text text-primary"></i> {{ _("QUOTED") }}
											<small class="text-muted d-block">{{ _("Quote provided") }}</small>
										</a>
										{% endif %}
									</div>
								</div>
								{% endif %}
							</div>
						</div>
						<div class="btn-group">
							{% if can_edit and schedule.status in ['DRAFT', 'READY'] %}
							<button class="btn btn-primary" data-toggle="modal" data-target="#addLineModal">
								<i class="fa fa-plus"></i> {{ _("Add Line") }}
							</button>
							{% endif %}
							{% if can_edit and schedule.status == 'READY' and not (is_dealer or is_internal) %}
							<button class="btn btn-success" onclick="requestQuote()">
								<i class="fa fa-paper-plane"></i> {{ _("Request Quote") }}
							</button>
							{% endif %}
							{% set can_create_order = can_edit and ((schedule.status in ['READY', 'QUOTED'] and (is_dealer or is_internal)) or (schedule.status == 'QUOTED' and not (is_dealer or is_internal))) %}
							{% if can_create_order %}
							<button class="btn btn-success" onclick="createSalesOrder()">
								<i class="fa fa-shopping-cart"></i> {{ _("Convert to Sales Order") }}
							</button>
							{% endif %}
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Summary Panel -->
	<div class="row mb-4">
		<div class="col-md-3 col-sm-6 mb-3 mb-md-0">
			<div class="card text-center h-100">
				<div class="card-body d-flex flex-column justify-content-center align-items-center">
					<h3 class="mb-0">{{ lines | length }}</h3>
					<small class="text-muted">{{ _("Total Lines") }}</small>
				</div>
			</div>
		</div>
		<div class="col-md-3 col-sm-6 mb-3 mb-md-0">
			<div class="card text-center h-100">
				<div class="card-body d-flex flex-column justify-content-center align-items-center">
					<h3 class="mb-0">{{ total_qty }}</h3>
					<small class="text-muted">{{ _("Total Qty") }}</small>
				</div>
			</div>
		</div>
		<div class="col-md-3 col-sm-6 mb-3 mb-md-0">
			<div class="card text-center h-100">
				<div class="card-body d-flex flex-column justify-content-center align-items-center">
					<h3 class="mb-0">{{ illumenate_count }}</h3>
					<small class="text-muted">{{ _("ilLumenate Fixtures") }}</small>
				</div>
			</div>
		</div>
		<div class="col-md-3 col-sm-6 mb-3 mb-md-0">
			<div class="card text-center h-100">
				<div class="card-body d-flex flex-column justify-content-center align-items-center">
					<h3 class="mb-0">{{ other_count }}</h3>
					<small class="text-muted">{{ _("Other Fixtures") }}</small>
				</div>
			</div>
		</div>
	</div>

	<!-- Fixture Lines Table -->
	<div class="row">
		<div class="col-12">
			<div class="card">
				<div class="card-header">
					<h5 class="mb-0">{{ _("Fixture Lines") }}</h5>
				</div>
				<div class="card-body p-0">
					{% if lines %}
					<div class="table-responsive">
						<table class="table table-hover mb-0">
							<thead class="thead-light">
								<tr>
									<th>{{ _("Line ID") }}</th>
									<th>{{ _("Type") }}</th>
									<th class="text-center">{{ _("Qty") }}</th>
									<th>{{ _("Location") }}</th>
									<th>{{ _("Details") }}</th>
									{% if can_edit %}
									<th class="text-center">{{ _("Actions") }}</th>
									{% endif %}
								</tr>
							</thead>
							<tbody>
								{% for line in lines %}
								<tr>
									<td>{{ line.line_id or line.idx }}</td>
									<td>
										<span class="badge badge-{{ 'primary' if line.manufacturer_type == 'ILLUMENATE' else 'secondary' }}">
											{{ line.manufacturer_type }}
										</span>
									</td>
									<td class="text-center">{{ line.qty }}</td>
									<td>{{ line.location or '-' }}</td>
									<td>
										{% if line.manufacturer_type == 'ILLUMENATE' and line.configured_fixture %}
										<a href="/portal/configure/{{ line.configured_fixture }}" class="text-primary">
											{{ line.ill_item_code or 'Configured' }}
										</a>
										<br>
										<small class="text-muted">
											{{ line.manufacturable_length_mm }}mm
										</small>
										{% elif line.manufacturer_type == 'OTHER' %}
										{{ line.manufacturer_name or '' }} {{ line.model_number or '' }}
										{% else %}
										<span class="text-muted">{{ _("Not configured") }}</span>
										{% endif %}
									</td>
									{% if can_edit %}
									<td class="text-center">
										<div class="action-buttons">
											{% if line.manufacturer_type == 'ILLUMENATE' %}
											<a href="/portal/configure?schedule={{ schedule.name }}&line_idx={{ loop.index0 }}" class="btn btn-sm btn-primary" title="{{ _('Configure') }}">
												<i class="fa fa-cog"></i> {{ _('Configure') }}
											</a>
											{% endif %}
											<button class="btn btn-sm btn-secondary" onclick="editLine({{ loop.index0 }})" title="{{ _('Edit') }}">
												<i class="fa fa-pencil"></i> {{ _('Edit') }}
											</button>
												<button class="btn btn-sm btn-outline-secondary" onclick="duplicateLine({{ loop.index0 }})" title="{{ _('Duplicate') }}">
													<i class="fa fa-copy"></i> {{ _('Duplicate') }}
												</button>
												<button class="btn btn-sm btn-outline-danger" onclick="deleteLine({{ loop.index0 }})" title="{{ _('Delete') }}">
													<i class="fa fa-trash"></i> {{ _('Delete') }}
											</button>
										</div>
									</td>
									{% endif %}
								</tr>
								{% endfor %}
							</tbody>
						</table>
					</div>
					{% else %}
					<div class="text-center py-5">
						<i class="fa fa-list fa-3x text-muted mb-3"></i>
						<p class="text-muted">{{ _("No fixture lines yet. Add a line to get started.") }}</p>
						{% if can_edit %}
						<button class="btn btn-primary" data-toggle="modal" data-target="#addLineModal">
							<i class="fa fa-plus"></i> {{ _("Add Line") }}
						</button>
						{% endif %}
					</div>
					{% endif %}
				</div>
			</div>
		</div>
	</div>

	<!-- Notes Section -->
	{% if schedule.notes %}
	<div class="row mt-4">
		<div class="col-12">
			<div class="card">
				<div class="card-header">
					<h5 class="mb-0">{{ _("Notes") }}</h5>
				</div>
				<div class="card-body">
					{{ schedule.notes }}
				</div>
			</div>
		</div>
	</div>
	{% endif %}

	<!-- Exports Section -->
	<div class="row mt-4">
		<div class="col-12">
			<div class="card">
				<div class="card-header d-flex justify-content-between align-items-center">
					<h5 class="mb-0">{{ _("Exports") }}</h5>
					<div class="btn-group">
						<button class="btn btn-sm btn-outline-primary" onclick="generateExport('pdf', false)">
							<i class="fa fa-file-pdf-o"></i> {{ _("PDF (No Pricing)") }}
						</button>
						{% if can_view_pricing %}
						<button class="btn btn-sm btn-outline-primary" onclick="generateExport('pdf', true)">
							<i class="fa fa-file-pdf-o"></i> {{ _("PDF (With Pricing)") }}
						</button>
						{% endif %}
						<button class="btn btn-sm btn-outline-secondary" onclick="generateExport('csv', false)">
							<i class="fa fa-file-excel-o"></i> {{ _("CSV (No Pricing)") }}
						</button>
						{% if can_view_pricing %}
						<button class="btn btn-sm btn-outline-secondary" onclick="generateExport('csv', true)">
							<i class="fa fa-file-excel-o"></i> {{ _("CSV (With Pricing)") }}
						</button>
						{% endif %}
					</div>
				</div>
				<div class="card-body p-0">
					<div id="exportHistoryContainer">
						<div class="text-center py-3">
							<i class="fa fa-spinner fa-spin"></i> {{ _("Loading export history...") }}
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<!-- Add Line Modal -->
<div class="modal fade" id="addLineModal" tabindex="-1" role="dialog">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">{{ _("Add Fixture Line") }}</h5>
				<button type="button" class="close" data-dismiss="modal">
					<span>&times;</span>
				</button>
			</div>
			<div class="modal-body">
				<form id="addLineForm">
					<div class="form-group">
						<label>{{ _("Line ID") }}</label>
						<input type="text" class="form-control" name="line_id" placeholder="A, B, C...">
					</div>
					<div class="form-group">
						<label>{{ _("Quantity") }}</label>
						<input type="number" class="form-control" name="qty" value="1" min="1">
					</div>
					<div class="form-group">
						<label>{{ _("Location") }}</label>
						<input type="text" class="form-control" name="location" placeholder="e.g., Kitchen, Office...">
					</div>
					<div class="form-group">
						<label>{{ _("Manufacturer Type") }}</label>
						<select class="form-control" name="manufacturer_type">
							<option value="ILLUMENATE">ilLumenate</option>
							<option value="OTHER">Other Manufacturer</option>
						</select>
					</div>
					<div class="form-group other-fields" style="display: none;">
						<label>{{ _("Manufacturer Name") }}</label>
						<input type="text" class="form-control" name="manufacturer_name">
					</div>
					<div class="form-group other-fields" style="display: none;">
						<label>{{ _("Model Number") }}</label>
						<input type="text" class="form-control" name="model_number">
					</div>
					<div class="form-group">
						<label>{{ _("Notes") }}</label>
						<textarea class="form-control" name="notes" rows="2"></textarea>
					</div>
				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-dismiss="modal">{{ _("Cancel") }}</button>
				<button type="button" class="btn btn-primary" onclick="addLine()">
					<i class="fa fa-plus"></i> {{ _("Add Line") }}
				</button>
			</div>
		</div>
	</div>
</div>

<!-- Edit Line Modal -->
<div class="modal fade" id="editLineModal" tabindex="-1" role="dialog">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">{{ _("Edit Fixture Line") }}</h5>
				<button type="button" class="close" data-dismiss="modal">
					<span>&times;</span>
				</button>
			</div>
			<div class="modal-body">
				<form id="editLineForm">
					<input type="hidden" name="edit_line_idx" id="edit_line_idx">
					<div class="form-group">
						<label>{{ _("Line ID") }}</label>
						<input type="text" class="form-control" name="edit_line_id" id="edit_line_id" placeholder="A, B, C...">
					</div>
					<div class="form-group">
						<label>{{ _("Quantity") }}</label>
						<input type="number" class="form-control" name="edit_qty" id="edit_qty" value="1" min="1">
					</div>
					<div class="form-group">
						<label>{{ _("Location") }}</label>
						<input type="text" class="form-control" name="edit_location" id="edit_location" placeholder="e.g., Kitchen, Office...">
					</div>
					<div class="form-group edit-other-fields" style="display: none;">
						<label>{{ _("Manufacturer Name") }}</label>
						<input type="text" class="form-control" name="edit_manufacturer_name" id="edit_manufacturer_name">
					</div>
					<div class="form-group edit-other-fields" style="display: none;">
						<label>{{ _("Model Number") }}</label>
						<input type="text" class="form-control" name="edit_model_number" id="edit_model_number">
					</div>
					<div class="form-group">
						<label>{{ _("Notes") }}</label>
						<textarea class="form-control" name="edit_notes" id="edit_notes" rows="2"></textarea>
					</div>
				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-dismiss="modal">{{ _("Cancel") }}</button>
				<button type="button" class="btn btn-primary" onclick="saveEditLine()">
					<i class="fa fa-save"></i> {{ _("Save Changes") }}
				</button>
			</div>
		</div>
	</div>
</div>
{% endif %}
{% endblock %}

{% block script %}
<script>
{% if is_new %}
// Handle create schedule form submission
$('#createScheduleForm').on('submit', function(e) {
	e.preventDefault();

	var form = $(this);
	var submitBtn = form.find('button[type="submit"]');

	// Prevent double submission
	if (submitBtn.prop('disabled')) {
		return;
	}

	submitBtn.prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i> Creating...');

	var data = {
		schedule_name: form.find('[name="schedule_name"]').val(),
		ill_project: form.find('[name="ill_project"]').val(),
		notes: form.find('[name="notes"]').val()
	};

	frappe.call({
		method: 'illumenate_lighting.illumenate_lighting.api.portal.create_schedule',
		args: {
			schedule_data: data
		},
		callback: function(r) {
			if (r.message && r.message.success) {
				frappe.msgprint({
					title: 'Success',
					indicator: 'green',
					message: 'Schedule created successfully'
				});
				// Redirect to the new schedule
				window.location.href = '/portal/schedules/' + r.message.schedule_name;
			} else {
				frappe.msgprint({
					title: 'Error',
					indicator: 'red',
					message: r.message.error || 'Error creating schedule'
				});
				submitBtn.prop('disabled', false).html('<i class="fa fa-plus"></i> Create Schedule');
			}
		},
		error: function() {
			submitBtn.prop('disabled', false).html('<i class="fa fa-plus"></i> Create Schedule');
		}
	});
});
{% else %}
var schedule_name = "{{ schedule.name }}";

// Toggle other manufacturer fields
$('select[name="manufacturer_type"]').on('change', function() {
	if ($(this).val() === 'OTHER') {
		$('.other-fields').show();
	} else {
		$('.other-fields').hide();
	}
});

function addLine() {
	var form = $('#addLineForm');
	var data = {
		line_id: form.find('[name="line_id"]').val(),
		qty: form.find('[name="qty"]').val(),
		location: form.find('[name="location"]').val(),
		manufacturer_type: form.find('[name="manufacturer_type"]').val(),
		manufacturer_name: form.find('[name="manufacturer_name"]').val(),
		model_number: form.find('[name="model_number"]').val(),
		notes: form.find('[name="notes"]').val()
	};

	frappe.call({
		method: 'illumenate_lighting.illumenate_lighting.api.portal.add_schedule_line',
		args: {
			schedule_name: schedule_name,
			line_data: data
		},
		callback: function(r) {
			if (r.message && r.message.success) {
				$('#addLineModal').modal('hide');
				location.reload();
			} else {
				frappe.msgprint(r.message.error || 'Error adding line');
			}
		}
	});
}

function duplicateLine(line_idx) {
	frappe.call({
		method: 'illumenate_lighting.illumenate_lighting.api.portal.duplicate_schedule_line',
		args: {
			schedule_name: schedule_name,
			line_idx: line_idx
		},
		callback: function(r) {
			if (r.message && r.message.success) {
				location.reload();
			} else {
				frappe.msgprint(r.message.error || 'Error duplicating line');
			}
		}
	});
}

// Line data for editing
var lineData = {{ lines_json | tojson if lines_json else '[]' }};

function editLine(line_idx) {
	var line = lineData[line_idx];
	if (!line) {
		frappe.msgprint('Line not found');
		return;
	}

	// Populate the edit form
	$('#edit_line_idx').val(line_idx);
	$('#edit_line_id').val(line.line_id || '');
	$('#edit_qty').val(line.qty || 1);
	$('#edit_location').val(line.location || '');
	$('#edit_notes').val(line.notes || '');

	// Show/hide other manufacturer fields
	if (line.manufacturer_type === 'OTHER') {
		$('.edit-other-fields').show();
		$('#edit_manufacturer_name').val(line.manufacturer_name || '');
		$('#edit_model_number').val(line.model_number || '');
	} else {
		$('.edit-other-fields').hide();
	}

	$('#editLineModal').modal('show');
}

function saveEditLine() {
	var line_idx = $('#edit_line_idx').val();
	var line_data = {
		line_id: $('#edit_line_id').val(),
		qty: $('#edit_qty').val(),
		location: $('#edit_location').val(),
		notes: $('#edit_notes').val(),
		manufacturer_name: $('#edit_manufacturer_name').val(),
		model_number: $('#edit_model_number').val()
	};

	frappe.call({
		method: 'illumenate_lighting.illumenate_lighting.api.portal.update_schedule_line',
		args: {
			schedule_name: schedule_name,
			line_idx: line_idx,
			line_data: line_data
		},
		callback: function(r) {
			if (r.message && r.message.success) {
				$('#editLineModal').modal('hide');
				location.reload();
			} else {
				frappe.msgprint(r.message.error || 'Error updating line');
			}
		}
	});
}

function deleteLine(line_idx) {
	frappe.confirm('Are you sure you want to delete this line?', function() {
		frappe.call({
			method: 'illumenate_lighting.illumenate_lighting.api.portal.delete_schedule_line',
			args: {
				schedule_name: schedule_name,
				line_idx: line_idx
			},
			callback: function(r) {
				if (r.message && r.message.success) {
					location.reload();
				}
			}
		});
	});
}

function changeStatus(new_status) {
	var statusLabels = {
		'DRAFT': 'Draft',
		'READY': 'Ready',
		'QUOTED': 'Quoted'
	};
	frappe.confirm('Change schedule status to ' + statusLabels[new_status] + '?', function() {
		frappe.call({
			method: 'illumenate_lighting.illumenate_lighting.api.portal.update_schedule_status',
			args: {
				schedule_name: schedule_name,
				new_status: new_status
			},
			callback: function(r) {
				if (r.message && r.message.success) {
					frappe.show_alert({
						message: 'Status updated to ' + new_status,
						indicator: 'green'
					});
					location.reload();
				} else {
					frappe.msgprint({
						title: 'Error',
						indicator: 'red',
						message: r.message.error || 'Error updating status'
					});
				}
			}
		});
	});
}

function requestQuote() {
	frappe.confirm('Request a quote for this schedule?', function() {
		frappe.call({
			method: 'illumenate_lighting.illumenate_lighting.api.portal.request_schedule_quote',
			args: {
				schedule_name: schedule_name
			},
			callback: function(r) {
				if (r.message && r.message.success) {
					frappe.msgprint({
						title: 'Success',
						indicator: 'green',
						message: 'Quote requested successfully'
					});
					location.reload();
				} else {
					frappe.msgprint(r.message.error || 'Error requesting quote');
				}
			}
		});
	});
}

function createSalesOrder() {
	frappe.confirm('Create a Sales Order from this schedule?', function() {
		frappe.call({
			method: 'illumenate_lighting.illumenate_lighting.api.portal.create_schedule_sales_order',
			args: {
				schedule_name: schedule_name
			},
			callback: function(r) {
				if (r.message && r.message.success) {
					frappe.msgprint('Sales Order ' + r.message.sales_order + ' created successfully');
					location.reload();
				} else {
					frappe.msgprint(r.message.error || 'Error creating Sales Order');
				}
			}
		});
	});
}

// Export functionality
function generateExport(format, priced) {
	var method = format === 'pdf'
		? 'illumenate_lighting.illumenate_lighting.api.exports.generate_schedule_pdf'
		: 'illumenate_lighting.illumenate_lighting.api.exports.generate_schedule_csv';

	frappe.show_alert({
		message: 'Generating ' + format.toUpperCase() + ' export...',
		indicator: 'blue'
	});

	frappe.call({
		method: method,
		args: {
			schedule_id: schedule_name,
			priced: priced
		},
		callback: function(r) {
			if (r.message && r.message.success) {
				frappe.show_alert({
					message: 'Export generated successfully!',
					indicator: 'green'
				});
				// Refresh export history
				loadExportHistory();
				// Open download in new tab
				if (r.message.download_url) {
					window.open(r.message.download_url, '_blank');
				}
			} else {
				frappe.msgprint({
					title: 'Export Error',
					indicator: 'red',
					message: r.message.error || 'Error generating export'
				});
			}
		},
		error: function() {
			frappe.msgprint({
				title: 'Export Error',
				indicator: 'red',
				message: 'Error generating export'
			});
		}
	});
}

function loadExportHistory() {
	frappe.call({
		method: 'illumenate_lighting.illumenate_lighting.api.exports.get_export_history',
		args: {
			schedule_id: schedule_name
		},
		callback: function(r) {
			if (r.message && r.message.success) {
				renderExportHistory(r.message.exports);
			} else {
				$('#exportHistoryContainer').html(
					'<div class="text-center text-muted py-3">' +
					'<i class="fa fa-exclamation-circle"></i> ' +
					(r.message.error || 'Error loading export history') +
					'</div>'
				);
			}
		}
	});
}

function renderExportHistory(exports) {
	if (!exports || exports.length === 0) {
		$('#exportHistoryContainer').html(
			'<div class="text-center text-muted py-3">' +
			'<i class="fa fa-download"></i> No exports yet. Use the buttons above to generate exports.' +
			'</div>'
		);
		return;
	}

	var html = '<div class="table-responsive"><table class="table table-hover mb-0">';
	html += '<thead class="thead-light"><tr>';
	html += '<th>Type</th>';
	html += '<th>Status</th>';
	html += '<th>Requested By</th>';
	html += '<th>Created</th>';
	html += '<th>Download</th>';
	html += '</tr></thead><tbody>';

	exports.forEach(function(exp) {
		var statusClass = {
			'QUEUED': 'warning',
			'RUNNING': 'info',
			'COMPLETE': 'success',
			'FAILED': 'danger'
		}[exp.status] || 'secondary';

		var typeLabel = exp.export_type.replace('_', ' ');
		var createdOn = exp.created_on ? frappe.datetime.prettyDate(exp.created_on) : '-';

		html += '<tr>';
		html += '<td>' + typeLabel + '</td>';
		html += '<td><span class="badge badge-' + statusClass + '">' + exp.status + '</span></td>';
		html += '<td>' + (exp.requested_by_name || '-') + '</td>';
		html += '<td>' + createdOn + '</td>';
		html += '<td>';
		if (exp.status === 'COMPLETE' && exp.output_file) {
			html += '<a href="' + exp.output_file + '" target="_blank" class="btn btn-sm btn-outline-primary">';
			html += '<i class="fa fa-download"></i> Download</a>';
		} else if (exp.status === 'FAILED') {
			html += '<span class="text-danger"><i class="fa fa-times"></i> Failed</span>';
		} else {
			html += '<span class="text-muted"><i class="fa fa-clock-o"></i> Pending</span>';
		}
		html += '</td>';
		html += '</tr>';
	});

	html += '</tbody></table></div>';
	$('#exportHistoryContainer').html(html);
}

// Load export history on page load
$(document).ready(function() {
	loadExportHistory();
});
{% endif %}
</script>
{% endblock %}
