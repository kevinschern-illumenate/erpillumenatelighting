{#
Portal Schedule Detail Page
Displays a fixture schedule with its lines and configurator actions
Also handles new schedule creation when is_new is True
#}
{% extends "templates/web.html" %}

{% block title %}{% if is_new %}{{ _("Create Schedule") }}{% else %}{{ schedule.schedule_name }}{% endif %}{% endblock %}

{% block style %}
<style>
.action-buttons .btn {
	margin-left: 2px;
	margin-right: 2px;
}
.action-buttons .btn i {
	pointer-events: none;
}
.fixture-details {
	line-height: 1.4;
}
.fixture-details .small span {
	white-space: nowrap;
}
.fixture-details .small i {
	width: 14px;
	text-align: center;
}
.fixture-details strong {
	font-size: 0.95rem;
}
.table td {
	vertical-align: middle;
}
</style>
{% endblock %}

{% block page_content %}
<div class="container portal-page">
	<!-- Breadcrumb -->
	<nav aria-label="breadcrumb" class="mb-4">
		<ol class="breadcrumb">
			<li class="breadcrumb-item"><a href="/portal/projects">{{ _("Projects") }}</a></li>
			<li class="breadcrumb-item"><a href="/portal/projects/{{ project.name }}">{{ project.project_name }}</a></li>
			<li class="breadcrumb-item active" aria-current="page">{% if is_new %}{{ _("Create Schedule") }}{% else %}{{ schedule.schedule_name }}{% endif %}</li>
		</ol>
	</nav>

	{% if is_new %}
	<!-- New Schedule Form -->
	<div class="row">
		<div class="col-lg-6">
			<div class="card">
				<div class="card-header">
					<h5 class="mb-0">{{ _("Create New Fixture Schedule") }}</h5>
				</div>
				<div class="card-body">
					<form id="createScheduleForm">
						<input type="hidden" name="ill_project" value="{{ project.name }}">
						<div class="form-group">
							<label>{{ _("Schedule Name") }} <span class="text-danger">*</span></label>
							<input type="text" class="form-control" name="schedule_name" required placeholder="{{ _('e.g., Area A - Linear Fixtures') }}">
						</div>
						<div class="form-group">
							<label>{{ _("Project") }}</label>
							<input type="text" class="form-control" value="{{ project.project_name }}" readonly>
						</div>
						<div class="form-group">
							<label>{{ _("Notes") }}</label>
							<textarea class="form-control" name="notes" rows="3" placeholder="{{ _('Optional notes about this schedule') }}"></textarea>
						</div>
						<hr>
						<div class="d-flex justify-content-between">
							<a href="/portal/projects/{{ project.name }}" class="btn btn-secondary">
								<i class="fa fa-arrow-left"></i> {{ _("Cancel") }}
							</a>
							<button type="submit" class="btn btn-primary">
								<i class="fa fa-plus"></i> {{ _("Create Schedule") }}
							</button>
						</div>
					</form>
				</div>
			</div>
		</div>
	</div>
	{% else %}

	<!-- Schedule Header -->
	<div class="row mb-4">
		<div class="col-12">
			<div class="card">
				<div class="card-body">
					<div class="d-flex justify-content-between align-items-start">
						<div>
							<h1 class="mb-2">{{ schedule.schedule_name }}</h1>
							<p class="text-muted mb-2">
								<strong>{{ _("Project") }}:</strong> {{ project.project_name }}
							</p>
							<div class="d-flex align-items-center gap-2">
								<span class="badge badge-{{ schedule_status_class(schedule.status) }}" id="statusBadge">
									{{ schedule.status }}
								</span>
								{% if can_edit and schedule.status not in ['ORDERED', 'CLOSED'] %}
								<div class="dropdown d-inline-block ml-2">
									<button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="statusDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
										<i class="fa fa-exchange"></i> {{ _("Change Status") }}
									</button>
									<div class="dropdown-menu" aria-labelledby="statusDropdown">
										{% if schedule.status != 'DRAFT' %}
										<a class="dropdown-item" href="#" onclick="changeStatus('DRAFT'); return false;">
											<i class="fa fa-pencil text-warning"></i> {{ _("DRAFT") }}
											<small class="text-muted d-block">{{ _("Continue editing") }}</small>
										</a>
										{% endif %}
										{% if schedule.status != 'READY' %}
										<a class="dropdown-item" href="#" onclick="changeStatus('READY'); return false;">
											<i class="fa fa-check-circle text-info"></i> {{ _("READY") }}
											<small class="text-muted d-block">{{ _("Ready for quote/order") }}</small>
										</a>
										{% endif %}
										{% if (is_dealer or is_internal) and schedule.status != 'QUOTED' %}
										<a class="dropdown-item" href="#" onclick="changeStatus('QUOTED'); return false;">
											<i class="fa fa-file-text text-primary"></i> {{ _("QUOTED") }}
											<small class="text-muted d-block">{{ _("Quote provided") }}</small>
										</a>
										{% endif %}
									</div>
								</div>
								{% endif %}
							</div>
						</div>
						<div class="btn-group">
							{% if can_edit and schedule.status in ['DRAFT', 'READY'] %}
							<button class="btn btn-primary" data-toggle="modal" data-target="#addLineModal">
								<i class="fa fa-plus"></i> {{ _("Add Line") }}
							</button>
							{% endif %}
							{% if can_edit and schedule.status == 'READY' and not (is_dealer or is_internal) %}
							<button class="btn btn-success" onclick="requestQuote()">
								<i class="fa fa-paper-plane"></i> {{ _("Request Quote") }}
							</button>
							{% endif %}
							{% set can_create_order = can_edit and ((schedule.status in ['READY', 'QUOTED'] and (is_dealer or is_internal)) or (schedule.status == 'QUOTED' and not (is_dealer or is_internal))) %}
							{% if can_create_order %}
							<button class="btn btn-success" onclick="createSalesOrder()">
								<i class="fa fa-shopping-cart"></i> {{ _("Convert to Sales Order") }}
							</button>
							{% endif %}
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Summary Panel -->
	<div class="row mb-4">
		<div class="col-md-3 col-sm-6 mb-3 mb-md-0">
			<div class="card text-center h-100">
				<div class="card-body d-flex flex-column justify-content-center align-items-center">
					<h3 class="mb-0">{{ lines | length }}</h3>
					<small class="text-muted">{{ _("Total Lines") }}</small>
				</div>
			</div>
		</div>
		<div class="col-md-3 col-sm-6 mb-3 mb-md-0">
			<div class="card text-center h-100">
				<div class="card-body d-flex flex-column justify-content-center align-items-center">
					<h3 class="mb-0">{{ total_qty }}</h3>
					<small class="text-muted">{{ _("Total Qty") }}</small>
				</div>
			</div>
		</div>
		<div class="col-md-3 col-sm-6 mb-3 mb-md-0">
			<div class="card text-center h-100">
				<div class="card-body d-flex flex-column justify-content-center align-items-center">
					<h3 class="mb-0">{{ illumenate_count }}</h3>
					<small class="text-muted">{{ _("ilLumenate Fixtures") }}</small>
				</div>
			</div>
		</div>
		<div class="col-md-3 col-sm-6 mb-3 mb-md-0">
			<div class="card text-center h-100">
				<div class="card-body d-flex flex-column justify-content-center align-items-center">
					<h3 class="mb-0">{{ other_count }}</h3>
					<small class="text-muted">{{ _("Other Fixtures") }}</small>
				</div>
			</div>
		</div>
	</div>

	<!-- Fixture Lines Table -->
	<div class="row">
		<div class="col-12">
			<div class="card">
				<div class="card-header">
					<h5 class="mb-0">{{ _("Fixture Lines") }}</h5>
				</div>
				<div class="card-body p-0">
					{% if lines %}
					<div class="table-responsive">
						<table class="table table-hover mb-0">
							<thead class="thead-light">
								<tr>
									<th>{{ _("Line ID") }}</th>
									<th>{{ _("Type") }}</th>
									<th class="text-center">{{ _("Qty") }}</th>
									<th>{{ _("Location") }}</th>
									<th>{{ _("Fixture Details") }}</th>
									{% if can_edit %}
									<th class="text-center">{{ _("Actions") }}</th>
									{% endif %}
								</tr>
							</thead>
							<tbody>
								{% for line in lines %}
								<tr>
									<td>{{ line.get('line_id') or line.get('idx') }}</td>
									<td>
										{% if line.get('manufacturer_type') == 'ILLUMENATE' %}
										<span class="badge badge-primary">ilLumenate</span>
										{% elif line.get('manufacturer_type') == 'ACCESSORY' %}
										<span class="badge badge-primary">ilLumenate</span>
										{% else %}
										<span class="badge badge-secondary">Other</span>
										{% endif %}
									</td>
									<td class="text-center">{{ line.get('qty') }}</td>
									<td>{{ line.get('location') or '-' }}</td>
									<td>
										<!-- DEBUG: Show raw line data -->
										<div class="small text-danger mb-1" style="font-size: 10px;">
											DEBUG: mfg_type={{ line.get('manufacturer_type') }}, 
											acc_item={{ line.get('accessory_item') }}, 
											acc_name={{ line.get('accessory_item_name') }}
										</div>
										{% if line.get('manufacturer_type') == 'ACCESSORY' and line.get('accessory_item') %}
										<div class="fixture-details">
											<strong class="text-success">{{ line.get('accessory_item_name') or line.get('accessory_item') }}</strong>
											<div class="small text-muted">
												<i class="fa fa-tag"></i> {{ line.get('accessory_item') }}
											</div>
											{% if line.get('accessory_item_description') %}
											<div class="small text-muted mt-1">
												{{ line.get('accessory_item_description')[:150] }}{% if line.get('accessory_item_description')|length > 150 %}...{% endif %}
											</div>
											{% endif %}
											{% if line.get('accessory_product_type') %}
											<div class="small text-muted">
												<i class="fa fa-folder"></i> {{ line.get('accessory_product_type') }}
											</div>
											{% endif %}
										</div>
										{% elif line.get('manufacturer_type') == 'ILLUMENATE' and line.get('configured_fixture') %}
										{% set cf_details = line.get('cf_details', {}) %}
										<div class="fixture-details">
											<!-- Part Number -->
											<strong class="text-primary">
												{{ cf_details.get('part_number') or line.get('ill_item_code') or 'Configured' }}
												{% if cf_details.get('is_multi_segment') %}
													<span class="badge badge-info ml-1" title="{{ _('Multi-segment fixture with jumper cables') }}">J</span>
												{% endif %}
											</strong>
											{% if cf_details.get('is_multi_segment') and cf_details.get('build_description') %}
											<div class="small text-info mt-1 build-description">
												<i class="fa fa-link"></i> 
												<em>{{ cf_details.get('user_segment_count', 0) }} segment(s) with jumper cables</em>
												<button type="button" class="btn btn-xs btn-link p-0 ml-1" 
														data-toggle="popover" 
														data-placement="bottom" 
														data-html="true"
														data-trigger="focus"
														title="{{ _('Build Details') }}"
														data-content="<pre class='mb-0 small'>{{ cf_details.get('build_description_display', '') | replace('\"', '&quot;') | replace('\n', '<br>') }}</pre>">
													<i class="fa fa-info-circle"></i>
												</button>
											</div>
											{% endif %}
											<!-- Environment Rating -->
											{% if cf_details.get('environment_rating') %}
											<div class="small text-muted">
												<i class="fa fa-tint"></i> Environment: {{ cf_details.get('environment_rating') }}
											</div>
											{% endif %}
											<!-- CCT -->
											{% if cf_details.get('cct') %}
											<div class="small text-muted">
												<i class="fa fa-thermometer-half"></i> CCT: {{ cf_details.get('cct') }}
											</div>
											{% endif %}
											<!-- CRI -->
											{% if cf_details.get('cri') %}
											<div class="small text-muted">
												<i class="fa fa-star"></i> CRI: {{ cf_details.get('cri') }}
											</div>
											{% endif %}
											<!-- Output (Delivered Lumens) -->
											{% if cf_details.get('estimated_delivered_output') %}
											<div class="small text-muted">
												<i class="fa fa-lightbulb-o"></i> Output: {{ cf_details.get('estimated_delivered_output') }} lm/ft
											</div>
											{% endif %}
											<!-- Lens -->
											{% if cf_details.get('lens_appearance') %}
											<div class="small text-muted">
												<i class="fa fa-eye"></i> Lens: {{ cf_details.get('lens_appearance') }}
											</div>
											{% endif %}
											<!-- Mounting -->
											{% if cf_details.get('mounting_method') %}
											<div class="small text-muted">
												<i class="fa fa-wrench"></i> Mounting: {{ cf_details.get('mounting_method') }}
											</div>
											{% endif %}
											<!-- Finish -->
											{% if cf_details.get('finish') %}
											<div class="small text-muted">
												<i class="fa fa-paint-brush"></i> Finish: {{ cf_details.get('finish') }}
											</div>
											{% endif %}
											<!-- Length -->
											{% if cf_details.get('manufacturable_length_inches') %}
											<div class="small text-muted">
												<i class="fa fa-arrows-h"></i> Length: <strong>{{ cf_details.get('manufacturable_length_inches') }}"</strong>
												{% if cf_details.get('is_multi_segment') %}
													<span class="text-info">({{ cf_details.get('user_segment_count', 0) }} segments)</span>
												{% endif %}
											</div>
											{% endif %}
											<!-- Feed or Build Description (show Build Description for jumpered fixtures instead of Feed) -->
											{% if cf_details.get('is_multi_segment') and cf_details.get('build_description') %}
											<div class="small text-muted">
												<i class="fa fa-link"></i> Build: {{ cf_details.get('build_description_display') | replace('\n', '; ') }}
											</div>
											{% elif cf_details.get('power_feed_type') %}
											<div class="small text-muted">
												<i class="fa fa-sign-in"></i> Feed: {{ cf_details.get('power_feed_type') }}
											</div>
											{% endif %}
											<!-- Input Voltage (Fixture Voltage) -->
											{% if cf_details.get('fixture_input_voltage') %}
											<div class="small text-muted">
												<i class="fa fa-flash"></i> Input Voltage: {{ cf_details.get('fixture_input_voltage') }}
											</div>
											{% endif %}
											<!-- PS Input Voltage (Driver Input Voltage) -->
											{% if cf_details.get('driver_input_voltage') %}
											<div class="small text-muted">
												<i class="fa fa-plug"></i> PS Input Voltage: {{ cf_details.get('driver_input_voltage') }}
											</div>
											{% endif %}
											<!-- Wattage / Power -->
											{% if cf_details.get('total_watts') %}
											<div class="small text-muted">
												<i class="fa fa-bolt"></i> Power: {{ cf_details.get('total_watts') }}W
											</div>
											{% endif %}
											<!-- Driver / Power Supply -->
											{% if cf_details.get('power_supply') %}
											<div class="small text-muted">
												<i class="fa fa-battery-full"></i> Driver: {{ cf_details.get('power_supply') }}
												{% if cf_details.get('power_supply_qty') and cf_details.get('power_supply_qty') > 1 %}
												<span class="badge badge-secondary ml-1">{{ cf_details.get('power_supply_qty') }} units</span>
												{% endif %}
											</div>
											{% endif %}
											<!-- Show message if no details available -->
											{% if not cf_details.get('cct') and not cf_details.get('cri') and not cf_details.get('finish') and not cf_details.get('manufacturable_length_inches') %}
											<div class="small text-warning mt-1">
												<i class="fa fa-exclamation-triangle"></i> Details pending - reconfigure to complete
											</div>
											{% endif %}
										</div>
										{% elif line.get('manufacturer_type') == 'OTHER' %}
										<div class="fixture-details">
											{% if line.get('manufacturer_name') %}
											<strong>{{ line.get('manufacturer_name') }}</strong>
											{% endif %}
											{% if line.get('fixture_model_number') %}
											<div class="small text-muted mt-1"><i class="fa fa-tag"></i> <strong>{{ line.get('fixture_model_number') }}</strong></div>
											{% endif %}
											{% if line.get('trim_info') %}
											<div class="small text-muted"><i class="fa fa-th"></i> Trim: {{ line.get('trim_info') }}</div>
											{% endif %}
											{% if line.get('housing_model_number') %}
											<div class="small text-muted"><i class="fa fa-cube"></i> Housing: {{ line.get('housing_model_number') }}</div>
											{% endif %}
											{% if line.get('driver_model_number') %}
											<div class="small text-muted"><i class="fa fa-plug"></i> Driver: {{ line.get('driver_model_number') }}</div>
											{% endif %}
											{% if line.get('lamp_info') %}
											<div class="small text-muted"><i class="fa fa-lightbulb-o"></i> Lamp: {{ line.get('lamp_info') }}</div>
											{% endif %}
											{% if line.get('dimming_protocol') %}
											<div class="small text-muted"><i class="fa fa-sliders"></i> Dimming: {{ line.get('dimming_protocol') }}</div>
											{% endif %}
											{% if line.get('input_voltage') %}
											<div class="small text-muted"><i class="fa fa-bolt"></i> Voltage: {{ line.get('input_voltage') }}</div>
											{% endif %}
											{% if line.get('other_finish') %}
											<div class="small text-muted"><i class="fa fa-paint-brush"></i> Finish: {{ line.get('other_finish') }}</div>
											{% endif %}
											{% if line.get('spec_sheet') %}
											<div class="small mt-1">
												<a href="{{ line.get('spec_sheet') }}" target="_blank" class="btn btn-sm btn-outline-secondary" title="{{ _('Download Spec Sheet') }}">
													<i class="fa fa-file-pdf-o"></i> {{ _("Spec Sheet") }}
												</a>
											</div>
											{% endif %}
										</div>
										{% elif line.get('manufacturer_type') == 'ILLUMENATE' %}
										<span class="text-muted">{{ _("Not configured") }}</span>
										{% else %}
										<span class="text-muted">-</span>
										{% endif %}
									</td>
									{% if can_edit %}
									<td class="text-center">
										<div class="action-buttons">
											{% if line.get('manufacturer_type') == 'ILLUMENATE' %}
												{% if line.get('configured_fixture') %}
												<!-- Edit existing configuration -->
												<a href="/portal/edit_fixture?schedule={{ schedule.name }}&line_idx={{ loop.index0 }}&fixture={{ line.get('configured_fixture') }}" class="btn btn-sm btn-info" title="{{ _('Edit Configuration') }}">
													<i class="fa fa-edit"></i> {{ _('Edit Config') }}
												</a>
												{% else %}
												<!-- Create new configuration -->
												<a href="/portal/configure?schedule={{ schedule.name }}&line_idx={{ loop.index0 }}" class="btn btn-sm btn-primary" title="{{ _('Configure') }}">
													<i class="fa fa-cog"></i> {{ _('Configure') }}
												</a>
												{% endif %}
											{% endif %}
											<button class="btn btn-sm btn-secondary" onclick="editLine({{ loop.index0 }})" title="{{ _('Edit Line Details') }}">
												<i class="fa fa-pencil"></i> {{ _('Edit') }}
											</button>
												<button class="btn btn-sm btn-outline-secondary" onclick="duplicateLine({{ loop.index0 }})" title="{{ _('Duplicate') }}">
													<i class="fa fa-copy"></i> {{ _('Duplicate') }}
												</button>
												<button class="btn btn-sm btn-outline-danger" onclick="deleteLine({{ loop.index0 }})" title="{{ _('Delete') }}">
													<i class="fa fa-trash"></i> {{ _('Delete') }}
											</button>
										</div>
									</td>
									{% endif %}
								</tr>
								{% endfor %}
							</tbody>
						</table>
					</div>
					{% else %}
					<div class="text-center py-5">
						<i class="fa fa-list fa-3x text-muted mb-3"></i>
						<p class="text-muted">{{ _("No fixture lines yet. Add a line to get started.") }}</p>
						{% if can_edit %}
						<button class="btn btn-primary" data-toggle="modal" data-target="#addLineModal">
							<i class="fa fa-plus"></i> {{ _("Add Line") }}
						</button>
						{% endif %}
					</div>
					{% endif %}
				</div>
			</div>
		</div>
	</div>

	<!-- Notes Section -->
	{% if schedule.notes %}
	<div class="row mt-4">
		<div class="col-12">
			<div class="card">
				<div class="card-header">
					<h5 class="mb-0">{{ _("Notes") }}</h5>
				</div>
				<div class="card-body">
					{{ schedule.notes }}
				</div>
			</div>
		</div>
	</div>
	{% endif %}

	<!-- Exports Section -->
	<div class="row mt-4">
		<div class="col-12">
			<div class="card">
				<div class="card-header d-flex justify-content-between align-items-center">
					<h5 class="mb-0">{{ _("Exports") }}</h5>
					<div class="btn-group">
						<button class="btn btn-sm btn-outline-primary" onclick="generateExport('pdf', false)">
							<i class="fa fa-file-pdf-o"></i> {{ _("PDF (No Pricing)") }}
						</button>
						{% if can_view_pricing %}
						<button class="btn btn-sm btn-outline-primary" onclick="generateExport('pdf', true)">
							<i class="fa fa-file-pdf-o"></i> {{ _("PDF (With Pricing)") }}
						</button>
						{% endif %}
						<button class="btn btn-sm btn-outline-secondary" onclick="generateExport('csv', false)">
							<i class="fa fa-file-excel-o"></i> {{ _("CSV (No Pricing)") }}
						</button>
						{% if can_view_pricing %}
						<button class="btn btn-sm btn-outline-secondary" onclick="generateExport('csv', true)">
							<i class="fa fa-file-excel-o"></i> {{ _("CSV (With Pricing)") }}
						</button>
						{% endif %}
					</div>
				</div>
				<div class="card-body p-0">
					<div id="exportHistoryContainer">
						<div class="text-center py-3">
							<i class="fa fa-spinner fa-spin"></i> {{ _("Loading export history...") }}
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<!-- Add Line Modal -->
<div class="modal fade" id="addLineModal" tabindex="-1" role="dialog">
	<div class="modal-dialog modal-lg" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">{{ _("Add Fixture Line") }}</h5>
				<button type="button" class="close" data-dismiss="modal">
					<span>&times;</span>
				</button>
			</div>
			<div class="modal-body">
				<form id="addLineForm">
					<div class="row">
						<div class="col-md-4">
							<div class="form-group">
								<label>{{ _("Line ID") }}</label>
								<input type="text" class="form-control" name="line_id" placeholder="A, B, C...">
							</div>
						</div>
						<div class="col-md-4">
							<div class="form-group">
								<label>{{ _("Quantity") }}</label>
								<input type="number" class="form-control" name="qty" value="1" min="1">
							</div>
						</div>
						<div class="col-md-4">
							<div class="form-group">
								<label>{{ _("Manufacturer Type") }}</label>
								<select class="form-control" name="manufacturer_type">
									<option value="ILLUMENATE">ilLumenate Lighting</option>
									<option value="OTHER">Other Manufacturer</option>
								</select>
							</div>
						</div>
					</div>
					<div class="form-group">
						<label>{{ _("Location") }}</label>
						<input type="text" class="form-control" name="location" placeholder="e.g., Kitchen, Office...">
					</div>

					<!-- ilLumenate Lighting Section (Combined Fixtures + Components) -->
					<div class="illumenate-fields" style="display: block;">
						<hr>
						<h6 class="text-muted mb-3">{{ _("ilLumenate Product Selection") }}</h6>
						<div class="row">
							<div class="col-md-6">
								<div class="form-group">
									<label>{{ _("Product Category") }}</label>
									<select class="form-control" name="product_type" id="add_product_type">
										<option value="">{{ _("Select Product Category...") }}</option>
									</select>
								</div>
							</div>
							<div class="col-md-6">
								<!-- Fixture Template dropdown (shown when Linear Fixture selected) -->
								<div class="form-group fixture-template-group" style="display: none;">
									<label>{{ _("Fixture Template") }}</label>
									<select class="form-control" name="fixture_template" id="add_fixture_template">
										<option value="">{{ _("Select Fixture Template...") }}</option>
									</select>
								</div>
								<!-- Item dropdown (shown when non-Linear Fixture category selected) -->
								<div class="form-group item-selection-group" style="display: none;">
									<label>{{ _("Item") }}</label>
									<select class="form-control" name="selected_item" id="add_selected_item">
										<option value="">{{ _("Select Item...") }}</option>
									</select>
								</div>
							</div>
						</div>

						<!-- Item details display -->
						<div class="selected-item-details" style="display: none;">
							<div class="alert alert-light">
								<div class="row">
									<div class="col-md-8">
										<strong id="add_selected_item_name"></strong>
										<p class="mb-0 text-muted small" id="add_selected_item_desc"></p>
									</div>
									<div class="col-md-4 text-right">
										<span class="badge badge-info" id="add_selected_item_uom"></span>
										<span class="badge badge-warning" id="add_selected_item_has_variants" style="display: none;">Has Options</span>
									</div>
								</div>
							</div>
						</div>

						<!-- Linear Fixture configure section -->
						<div class="fixture-configure-section" style="display: none;">
							<div class="alert alert-info">
								<i class="fa fa-info-circle"></i> 
								{{ _("For ilLumenate fixtures, you can configure the fixture after adding this line, or click the button below to configure now.") }}
							</div>
							<button type="button" class="btn btn-primary btn-block" id="configureFromAddBtn" onclick="configureFromAddModal()">
								<i class="fa fa-cog"></i> {{ _("Configure Fixture Now") }}
							</button>
						</div>

						<!-- Item with variants configure section -->
						<div class="item-configure-section" style="display: none;">
							<div class="alert alert-info">
								<i class="fa fa-cog"></i> 
								{{ _("This item has configurable options. Click Configure to select the specific variant.") }}
							</div>
							<button type="button" class="btn btn-success btn-block" id="configureItemBtn" onclick="openItemVariantModal()">
								<i class="fa fa-cog"></i> {{ _("Configure Options") }}
							</button>
							<!-- Hidden field to store selected variant -->
							<input type="hidden" name="selected_variant" id="add_selected_variant">
							<div class="selected-variant-display" style="display: none; margin-top: 10px;">
								<div class="alert alert-success">
									<i class="fa fa-check-circle"></i> 
									<strong>{{ _("Selected:") }}</strong> <span id="selected_variant_name"></span>
								</div>
							</div>
						</div>

						<!-- No configure needed (direct item add) -->
						<div class="item-direct-section" style="display: none;">
							<div class="alert alert-success">
								<i class="fa fa-check-circle"></i> 
								{{ _("This item will be added directly to your schedule.") }}
							</div>
						</div>
					</div>

					<!-- Other Manufacturer Fields -->
					<div class="other-fields" style="display: none;">
						<hr>
						<h6 class="text-muted mb-3">{{ _("Other Manufacturer Details") }}</h6>
						<div class="row">
							<div class="col-md-6">
								<div class="form-group">
									<label>{{ _("Manufacturer Name") }} <span class="text-danger">*</span></label>
									<input type="text" class="form-control" name="manufacturer_name">
								</div>
							</div>
							<div class="col-md-6">
								<div class="form-group">
									<label>{{ _("Fixture Model Number") }}</label>
									<input type="text" class="form-control" name="fixture_model_number">
								</div>
							</div>
						</div>
						<div class="row">
							<div class="col-md-6">
								<div class="form-group">
									<label>{{ _("Trim Information") }}</label>
									<input type="text" class="form-control" name="trim_info">
								</div>
							</div>
							<div class="col-md-6">
								<div class="form-group">
									<label>{{ _("Housing Model Number") }}</label>
									<input type="text" class="form-control" name="housing_model_number">
								</div>
							</div>
						</div>
						<div class="row">
							<div class="col-md-6">
								<div class="form-group">
									<label>{{ _("Driver Model Number") }}</label>
									<input type="text" class="form-control" name="driver_model_number">
								</div>
							</div>
							<div class="col-md-6">
								<div class="form-group">
									<label>{{ _("Lamp Information") }}</label>
									<input type="text" class="form-control" name="lamp_info">
								</div>
							</div>
						</div>
						<div class="row">
							<div class="col-md-6">
								<div class="form-group">
									<label>{{ _("Dimming Protocol") }}</label>
									<input type="text" class="form-control" name="dimming_protocol" placeholder="e.g., 0-10V, DALI, Triac...">
								</div>
							</div>
							<div class="col-md-6">
								<div class="form-group">
									<label>{{ _("Input Voltage") }}</label>
									<input type="text" class="form-control" name="input_voltage" placeholder="e.g., 120V, 277V...">
								</div>
							</div>
						</div>
						<div class="row">
							<div class="col-md-6">
								<div class="form-group">
									<label>{{ _("Finish") }}</label>
									<input type="text" class="form-control" name="other_finish">
								</div>
							</div>
							<div class="col-md-6">
								<div class="form-group">
									<label>{{ _("Spec Sheet") }}</label>
									<input type="file" class="form-control-file" name="spec_sheet_file" id="add_spec_sheet_file">
									<small class="text-muted">{{ _("Upload a spec sheet PDF or image") }}</small>
								</div>
							</div>
						</div>
					</div>

					<div class="form-group">
						<label>{{ _("Notes") }}</label>
						<textarea class="form-control" name="notes" rows="2"></textarea>
					</div>
				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-dismiss="modal">{{ _("Cancel") }}</button>
				<button type="button" class="btn btn-primary" id="addLineBtn" onclick="addLine()">
					<i class="fa fa-plus"></i> {{ _("Add Line") }}
				</button>
			</div>
		</div>
	</div>
</div>

<!-- Edit Line Modal -->
<div class="modal fade" id="editLineModal" tabindex="-1" role="dialog">
	<div class="modal-dialog modal-lg" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">{{ _("Edit Fixture Line") }}</h5>
				<button type="button" class="close" data-dismiss="modal">
					<span>&times;</span>
				</button>
			</div>
			<div class="modal-body">
				<form id="editLineForm">
					<input type="hidden" name="edit_line_idx" id="edit_line_idx">
					<div class="row">
						<div class="col-md-4">
							<div class="form-group">
								<label>{{ _("Line ID") }}</label>
								<input type="text" class="form-control" name="edit_line_id" id="edit_line_id" placeholder="A, B, C...">
							</div>
						</div>
						<div class="col-md-4">
							<div class="form-group">
								<label>{{ _("Quantity") }}</label>
								<input type="number" class="form-control" name="edit_qty" id="edit_qty" value="1" min="1">
							</div>
						</div>
						<div class="col-md-4">
							<div class="form-group">
								<label>{{ _("Manufacturer Type") }}</label>
								<input type="text" class="form-control" id="edit_manufacturer_type" readonly>
							</div>
						</div>
					</div>
					<div class="form-group">
						<label>{{ _("Location") }}</label>
						<input type="text" class="form-control" name="edit_location" id="edit_location" placeholder="e.g., Kitchen, Office...">
					</div>

					<!-- Other Manufacturer Fields -->
					<div class="edit-other-fields" style="display: none;">
						<hr>
						<h6 class="text-muted mb-3">{{ _("Other Manufacturer Details") }}</h6>
						<div class="row">
							<div class="col-md-6">
								<div class="form-group">
									<label>{{ _("Manufacturer Name") }} <span class="text-danger">*</span></label>
									<input type="text" class="form-control" name="edit_manufacturer_name" id="edit_manufacturer_name">
								</div>
							</div>
							<div class="col-md-6">
								<div class="form-group">
									<label>{{ _("Fixture Model Number") }}</label>
									<input type="text" class="form-control" name="edit_fixture_model_number" id="edit_fixture_model_number">
								</div>
							</div>
						</div>
						<div class="row">
							<div class="col-md-6">
								<div class="form-group">
									<label>{{ _("Trim Information") }}</label>
									<input type="text" class="form-control" name="edit_trim_info" id="edit_trim_info">
								</div>
							</div>
							<div class="col-md-6">
								<div class="form-group">
									<label>{{ _("Housing Model Number") }}</label>
									<input type="text" class="form-control" name="edit_housing_model_number" id="edit_housing_model_number">
								</div>
							</div>
						</div>
						<div class="row">
							<div class="col-md-6">
								<div class="form-group">
									<label>{{ _("Driver Model Number") }}</label>
									<input type="text" class="form-control" name="edit_driver_model_number" id="edit_driver_model_number">
								</div>
							</div>
							<div class="col-md-6">
								<div class="form-group">
									<label>{{ _("Lamp Information") }}</label>
									<input type="text" class="form-control" name="edit_lamp_info" id="edit_lamp_info">
								</div>
							</div>
						</div>
						<div class="row">
							<div class="col-md-6">
								<div class="form-group">
									<label>{{ _("Dimming Protocol") }}</label>
									<input type="text" class="form-control" name="edit_dimming_protocol" id="edit_dimming_protocol">
								</div>
							</div>
							<div class="col-md-6">
								<div class="form-group">
									<label>{{ _("Input Voltage") }}</label>
									<input type="text" class="form-control" name="edit_input_voltage" id="edit_input_voltage">
								</div>
							</div>
						</div>
						<div class="row">
							<div class="col-md-6">
								<div class="form-group">
									<label>{{ _("Finish") }}</label>
									<input type="text" class="form-control" name="edit_other_finish" id="edit_other_finish">
								</div>
							</div>
							<div class="col-md-6">
								<div class="form-group">
									<label>{{ _("Spec Sheet") }}</label>
									<div id="edit_spec_sheet_current" class="mb-2"></div>
									<input type="file" class="form-control-file" name="edit_spec_sheet_file" id="edit_spec_sheet_file">
									<small class="text-muted">{{ _("Upload a new spec sheet to replace existing") }}</small>
								</div>
							</div>
						</div>
					</div>

					<!-- ilLumenate Item Fields (read-only display in edit mode) -->
					<div class="edit-accessory-fields" style="display: none;">
						<hr>
						<h6 class="text-muted mb-3">{{ _("ilLumenate Product") }}</h6>
						<div class="row">
							<div class="col-md-6">
								<div class="form-group">
									<label>{{ _("Product Category") }}</label>
									<input type="text" class="form-control" id="edit_accessory_product_type" readonly>
								</div>
							</div>
							<div class="col-md-6">
								<div class="form-group">
									<label>{{ _("Item") }}</label>
									<input type="text" class="form-control" id="edit_accessory_item" readonly>
								</div>
							</div>
						</div>
						<div class="alert alert-info">
							<i class="fa fa-info-circle"></i> {{ _("To change the item, delete this line and add a new one.") }}
						</div>
					</div>

					<div class="form-group">
						<label>{{ _("Notes") }}</label>
						<textarea class="form-control" name="edit_notes" id="edit_notes" rows="2"></textarea>
					</div>
				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-dismiss="modal">{{ _("Cancel") }}</button>
				<button type="button" class="btn btn-primary" onclick="saveEditLine()">
					<i class="fa fa-save"></i> {{ _("Save Changes") }}
				</button>
			</div>
		</div>
	</div>
</div>

<!-- Item Variant Configuration Modal -->
<div class="modal fade" id="itemVariantModal" tabindex="-1" role="dialog">
	<div class="modal-dialog modal-lg" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">{{ _("Configure Item Options") }}</h5>
				<button type="button" class="close" data-dismiss="modal">
					<span>&times;</span>
				</button>
			</div>
			<div class="modal-body">
				<div class="variant-config-loading text-center" style="display: none;">
					<i class="fa fa-spinner fa-spin fa-2x"></i>
					<p class="mt-2">{{ _("Loading options...") }}</p>
				</div>
				<div class="variant-config-content">
					<div class="alert alert-info">
						<strong id="variant_template_name"></strong>
						<p class="mb-0 small text-muted" id="variant_template_desc">{{ _("Select your preferred options below:") }}</p>
					</div>
					<div id="variant_attributes_container">
						<!-- Attribute dropdowns will be dynamically inserted here -->
					</div>
					<div class="variant-match-status" style="display: none; margin-top: 15px;">
						<div class="alert alert-success variant-found" style="display: none;">
							<i class="fa fa-check-circle"></i> 
							<strong>{{ _("Matched:") }}</strong> <span id="matched_variant_name"></span>
						</div>
						<div class="alert alert-warning variant-not-found" style="display: none;">
							<i class="fa fa-exclamation-triangle"></i> 
							{{ _("No matching variant found for the selected options. Please try a different combination.") }}
						</div>
					</div>
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-dismiss="modal">{{ _("Cancel") }}</button>
				<button type="button" class="btn btn-primary" id="confirmVariantBtn" onclick="confirmVariantSelection()" disabled>
					<i class="fa fa-check"></i> {{ _("Confirm Selection") }}
				</button>
			</div>
		</div>
	</div>
</div>
{% endif %}
{% endblock %}

{% block script %}
<script>
{% if is_new %}
// Handle create schedule form submission
$('#createScheduleForm').on('submit', function(e) {
	e.preventDefault();

	var form = $(this);
	var submitBtn = form.find('button[type="submit"]');

	// Prevent double submission
	if (submitBtn.prop('disabled')) {
		return;
	}

	submitBtn.prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i> Creating...');

	var data = {
		schedule_name: form.find('[name="schedule_name"]').val(),
		ill_project: form.find('[name="ill_project"]').val(),
		notes: form.find('[name="notes"]').val()
	};

	frappe.call({
		method: 'illumenate_lighting.illumenate_lighting.api.portal.create_schedule',
		args: {
			schedule_data: data
		},
		callback: function(r) {
			if (r.message && r.message.success) {
				frappe.msgprint({
					title: 'Success',
					indicator: 'green',
					message: 'Schedule created successfully'
				});
				// Redirect to the new schedule
				window.location.href = '/portal/schedules/' + r.message.schedule_name;
			} else {
				frappe.msgprint({
					title: 'Error',
					indicator: 'red',
					message: r.message.error || 'Error creating schedule'
				});
				submitBtn.prop('disabled', false).html('<i class="fa fa-plus"></i> Create Schedule');
			}
		},
		error: function() {
			submitBtn.prop('disabled', false).html('<i class="fa fa-plus"></i> Create Schedule');
		}
	});
});
{% else %}
var schedule_name = "{{ schedule.name }}";

// Initialize Bootstrap popovers for build description
$('[data-toggle="popover"]').popover();

// Reset add line modal when opened
$('#addLineModal').on('show.bs.modal', function() {
	// Reset the form
	$('#addLineForm')[0].reset();
	// Reset to default ilLumenate view
	$('select[name="manufacturer_type"]').val('ILLUMENATE');
	$('.illumenate-fields').show();
	$('.other-fields').hide();
	// Reset product type and related fields
	$('#add_product_type').val('');
	$('.fixture-template-group').hide();
	$('.item-selection-group').hide();
	$('.selected-item-details').hide();
	$('.fixture-configure-section').hide();
	$('.item-configure-section').hide();
	$('.item-direct-section').hide();
	$('.selected-variant-display').hide();
	$('#add_fixture_template').html('<option value="">{{ _("Select Fixture Template...") }}</option>');
	$('#add_selected_item').html('<option value="">{{ _("Select Item...") }}</option>');
	$('#add_selected_variant').val('');
	// Load product categories
	loadProductCategories();
});

// Toggle manufacturer type fields
$('select[name="manufacturer_type"]').on('change', function() {
	var mfgType = $(this).val();
	$('.illumenate-fields').hide();
	$('.other-fields').hide();
	
	if (mfgType === 'ILLUMENATE') {
		$('.illumenate-fields').show();
	} else if (mfgType === 'OTHER') {
		$('.other-fields').show();
	}
});

// Initialize the visibility on page load (default is ILLUMENATE)
$('.illumenate-fields').show();
$('.other-fields').hide();

// Handle product type selection to show appropriate fields
$('#add_product_type').on('change', function() {
	var productType = $(this).val();
	var $selected = $(this).find('option:selected');
	var rawIsFixtureType = $selected.data('is-fixture-type');
	var isFixtureType = rawIsFixtureType === 1 || rawIsFixtureType === '1' || rawIsFixtureType === true || rawIsFixtureType === 'true';
	
	// DEBUG: Log what we're getting
	console.log('=== Product Type Selection Debug ===' );
	console.log('productType:', productType);
	console.log('rawIsFixtureType:', rawIsFixtureType, 'type:', typeof rawIsFixtureType);
	console.log('isFixtureType (computed):', isFixtureType);
	console.log('$selected html:', $selected.prop('outerHTML'));
	
	// Hide all conditional sections first
	$('.fixture-template-group').hide();
	$('.item-selection-group').hide();
	$('.selected-item-details').hide();
	$('.fixture-configure-section').hide();
	$('.item-configure-section').hide();
	$('.item-direct-section').hide();
	$('.selected-variant-display').hide();
	$('#add_selected_variant').val('');
	
	if (!productType) {
		return;
	}
	
	// Check if this is a fixture type (e.g., "Linear Fixture") - show fixture template dropdown
	if (isFixtureType) {
		console.log('Showing FIXTURE TEMPLATE fields');
		$('.fixture-template-group').show();
		$('.fixture-configure-section').show();
		loadFixtureTemplates(productType);
	} else {
		console.log('Showing ITEM SELECTION fields');
		// For all other product types, show item selection dropdown
		$('.item-selection-group').show();
		loadItemsForProductType(productType);
	}
});

// Load fixture templates from the server
function loadFixtureTemplates(productType) {
	$('#add_fixture_template').html('<option value="">{{ _("Loading...") }}</option>');
	
	frappe.call({
		method: 'illumenate_lighting.illumenate_lighting.api.portal.get_fixture_templates',
		args: {
			product_type: productType
		},
		callback: function(r) {
			var options = '<option value="">{{ _("Select Fixture Template...") }}</option>';
			if (r.message && r.message.templates) {
				r.message.templates.forEach(function(template) {
					options += '<option value="' + template.name + '">' + template.template_name + ' (' + template.template_code + ')</option>';
				});
			}
			$('#add_fixture_template').html(options);
		},
		error: function() {
			$('#add_fixture_template').html('<option value="">{{ _("Error loading templates") }}</option>');
		}
	});
}

// Load product categories (Item Groups under Products)
function loadProductCategories() {
	console.log('=== Loading Product Categories ===');
	frappe.call({
		method: 'illumenate_lighting.illumenate_lighting.api.portal.get_product_types',
		callback: function(r) {
			console.log('get_product_types response:', r.message);
			var options = '<option value="">{{ _("Select Product Category...") }}</option>';
			if (r.message && r.message.success && r.message.product_types) {
				r.message.product_types.forEach(function(pt) {
					console.log('Product type:', pt.value, 'is_fixture_type:', pt.is_fixture_type);
					// Add visual indentation based on level
					var indent = '';
					if (pt.level === 1) {
						indent = '└─ ';
					} else if (pt.level === 2) {
						indent = '    └─ ';
					}
					// Store is_fixture_type as data attribute
					options += '<option value="' + pt.value + '" data-is-fixture-type="' + (pt.is_fixture_type ? '1' : '0') + '">' + indent + pt.label + '</option>';
				});
			}
			$('#add_product_type').html(options);
			console.log('Options HTML:', options);
		},
		error: function(err) {
			console.error('Error loading product categories:', err);
		}
	});
}

// Load items for a product type (excluding variants)
function loadItemsForProductType(productType) {
	$('#add_selected_item').html('<option value="">{{ _("Loading...") }}</option>');
	
	frappe.call({
		method: 'illumenate_lighting.illumenate_lighting.api.portal.get_items_by_product_type',
		args: {
			product_type: productType,
			exclude_variants: 1
		},
		callback: function(r) {
			var options = '<option value="">{{ _("Select Item...") }}</option>';
			if (r.message && r.message.success && r.message.items) {
				r.message.items.forEach(function(item) {
					options += '<option value="' + item.item_code + '" ' +
						'data-name="' + (item.item_name || '') + '" ' +
						'data-desc="' + (item.description || '').substring(0, 100) + '" ' +
						'data-uom="' + (item.stock_uom || 'Nos') + '" ' +
						'data-rate="' + (item.standard_rate || 0) + '" ' +
						'data-has-variants="' + (item.has_variants ? '1' : '0') + '">' + 
						item.item_name + ' (' + item.item_code + ')' +
						(item.has_variants ? ' ⚙' : '') +
						'</option>';
				});
			}
			$('#add_selected_item').html(options);
		},
		error: function() {
			$('#add_selected_item').html('<option value="">{{ _("Error loading items") }}</option>');
		}
	});
}

// Handle item selection
$('#add_selected_item').on('change', function() {
	var $selected = $(this).find('option:selected');
	var itemCode = $(this).val();
	
	// Hide all item-related sections first
	$('.selected-item-details').hide();
	$('.item-configure-section').hide();
	$('.item-direct-section').hide();
	$('.selected-variant-display').hide();
	$('#add_selected_variant').val('');
	
	if (!itemCode) {
		return;
	}
	
	// Show item details
	$('#add_selected_item_name').text($selected.data('name') || itemCode);
	$('#add_selected_item_desc').text($selected.data('desc') || '');
	$('#add_selected_item_uom').text($selected.data('uom') || 'Nos');
	$('.selected-item-details').show();
	
	// Check if item has variants
	var hasVariants = $selected.data('has-variants') === '1' || $selected.data('has-variants') === 1;
	
	if (hasVariants) {
		// Show badge and configure button
		$('#add_selected_item_has_variants').show();
		$('.item-configure-section').show();
	} else {
		// No variants - direct add
		$('#add_selected_item_has_variants').hide();
		$('.item-direct-section').show();
	}
});

// Store current template item for variant selection
var currentTemplateItem = null;
var currentVariantMatch = null;

// Open item variant configuration modal
function openItemVariantModal() {
	var itemCode = $('#add_selected_item').val();
	var $selected = $('#add_selected_item option:selected');
	
	if (!itemCode) {
		frappe.msgprint({
			title: '{{ _("Selection Required") }}',
			indicator: 'orange',
			message: '{{ _("Please select an item first.") }}'
		});
		return;
	}
	
	currentTemplateItem = itemCode;
	currentVariantMatch = null;
	
	// Show loading state
	$('.variant-config-loading').show();
	$('.variant-config-content').hide();
	$('#confirmVariantBtn').prop('disabled', true);
	$('.variant-match-status').hide();
	
	// Set template name in modal
	$('#variant_template_name').text($selected.data('name') || itemCode);
	
	// Open modal
	$('#itemVariantModal').modal('show');
	
	// Load variant attributes
	frappe.call({
		method: 'illumenate_lighting.illumenate_lighting.api.portal.get_item_variant_attributes',
		args: {
			template_item: itemCode
		},
		callback: function(r) {
			$('.variant-config-loading').hide();
			$('.variant-config-content').show();
			
			if (r.message && r.message.success && r.message.attributes && r.message.attributes.length > 0) {
				// Build attribute dropdowns
				var html = '';
				r.message.attributes.forEach(function(attr, index) {
					html += '<div class="form-group">';
					html += '<label>' + attr.attribute + '</label>';
					html += '<select class="form-control variant-attribute-select" data-attribute="' + attr.attribute + '">';
					html += '<option value="">{{ _("Select") }} ' + attr.attribute + '...</option>';
					attr.values.forEach(function(val) {
						if (val.is_numeric) {
							html += '<option value="' + val.value + '">' + val.value + '</option>';
						} else {
							html += '<option value="' + val.value + '">' + val.value + '</option>';
						}
					});
					html += '</select>';
					html += '</div>';
				});
				$('#variant_attributes_container').html(html);
				
				// Add change handler to check for matching variants
				$('.variant-attribute-select').on('change', checkVariantMatch);
			} else {
				$('#variant_attributes_container').html('<div class="alert alert-warning">{{ _("No configurable options available for this item.") }}</div>');
			}
		},
		error: function() {
			$('.variant-config-loading').hide();
			$('.variant-config-content').show();
			$('#variant_attributes_container').html('<div class="alert alert-danger">{{ _("Error loading options. Please try again.") }}</div>');
		}
	});
}

// Check if selected attributes match a variant
function checkVariantMatch() {
	// Collect all selected attribute values
	var selectedAttributes = {};
	var allSelected = true;
	
	$('.variant-attribute-select').each(function() {
		var attr = $(this).data('attribute');
		var val = $(this).val();
		if (val) {
			selectedAttributes[attr] = val;
		} else {
			allSelected = false;
		}
	});
	
	// Only check for match if all attributes are selected
	if (!allSelected) {
		$('.variant-match-status').hide();
		$('#confirmVariantBtn').prop('disabled', true);
		currentVariantMatch = null;
		return;
	}
	
	// Find matching variant
	frappe.call({
		method: 'illumenate_lighting.illumenate_lighting.api.portal.find_matching_variant',
		args: {
			template_item: currentTemplateItem,
			selected_attributes: selectedAttributes
		},
		callback: function(r) {
			$('.variant-match-status').show();
			
			if (r.message && r.message.success && r.message.found) {
				// Match found
				$('.variant-found').show();
				$('.variant-not-found').hide();
				$('#matched_variant_name').text(r.message.variant.item_name + ' (' + r.message.variant.item_code + ')');
				$('#confirmVariantBtn').prop('disabled', false);
				currentVariantMatch = r.message.variant;
			} else {
				// No match
				$('.variant-found').hide();
				$('.variant-not-found').show();
				$('#confirmVariantBtn').prop('disabled', true);
				currentVariantMatch = null;
			}
		}
	});
}

// Confirm variant selection
function confirmVariantSelection() {
	if (!currentVariantMatch) {
		frappe.msgprint({
			title: '{{ _("No Match") }}',
			indicator: 'orange',
			message: '{{ _("Please select options that match an available variant.") }}'
		});
		return;
	}
	
	// Store the selected variant
	$('#add_selected_variant').val(currentVariantMatch.item_code);
	
	// Update the display
	$('#selected_variant_name').text(currentVariantMatch.item_name + ' (' + currentVariantMatch.item_code + ')');
	$('.selected-variant-display').show();
	
	// Close modal
	$('#itemVariantModal').modal('hide');
}

// File upload helper function
function uploadFile(fileInput, callback) {
	var file = fileInput.files[0];
	if (!file) {
		callback(null);
		return;
	}

	var formData = new FormData();
	formData.append('file', file);
	formData.append('is_private', 0);
	formData.append('folder', 'Home/Attachments');

	$.ajax({
		url: '/api/method/upload_file',
		type: 'POST',
		data: formData,
		processData: false,
		contentType: false,
		headers: {
			'X-Frappe-CSRF-Token': frappe.csrf_token
		},
		success: function(r) {
			if (r.message && r.message.file_url) {
				callback(r.message.file_url);
			} else {
				callback(null);
			}
		},
		error: function() {
			callback(null);
		}
	});
}

function addLine() {
	var form = $('#addLineForm');
	var manufacturerType = form.find('[name="manufacturer_type"]').val();
	var productType = form.find('[name="product_type"]').val();
	var $productTypeSelected = form.find('[name="product_type"] option:selected');
	var isFixtureType = $productTypeSelected.data('is-fixture-type') === 1 || $productTypeSelected.data('is-fixture-type') === '1' || $productTypeSelected.data('is-fixture-type') === true;
	
	// DEBUG: Log what we're submitting
	console.log('=== addLine Debug ===');
	console.log('manufacturerType:', manufacturerType);
	console.log('productType:', productType);
	console.log('isFixtureType:', isFixtureType);
	console.log('$productTypeSelected data:', $productTypeSelected.data('is-fixture-type'));
	
	var data = {
		line_id: form.find('[name="line_id"]').val(),
		qty: form.find('[name="qty"]').val(),
		location: form.find('[name="location"]').val(),
		manufacturer_type: manufacturerType,
		notes: form.find('[name="notes"]').val()
	};

	// Handle ilLumenate products
	if (manufacturerType === 'ILLUMENATE') {
		data.product_type = productType;
		
		// Check if this is a fixture type using the data attribute
		if (isFixtureType) {
			// Linear Fixture path - uses fixture template and configurator
			console.log('Using FIXTURE TEMPLATE path');
			data.fixture_template = form.find('[name="fixture_template"]').val();
			data.configuration_status = 'Pending';
		} else if (productType) {
			// Other product types - uses item selection (potentially with variants)
			console.log('Using ITEM SELECTION path');
			var selectedItem = form.find('[name="selected_item"]').val();
			var selectedVariant = form.find('[name="selected_variant"]').val();
			
			console.log('selectedItem:', selectedItem);
			console.log('selectedVariant:', selectedVariant);
			
			if (!selectedItem) {
				frappe.msgprint({
					title: '{{ _("Selection Required") }}',
					indicator: 'orange',
					message: '{{ _("Please select an item before adding the line.") }}'
				});
				return;
			}
			
			// Check if item has variants and if one was selected
			var $selectedOption = form.find('[name="selected_item"] option:selected');
			var hasVariants = $selectedOption.data('has-variants') === '1' || $selectedOption.data('has-variants') === 1;
			
			if (hasVariants && !selectedVariant) {
				frappe.msgprint({
					title: '{{ _("Configuration Required") }}',
					indicator: 'orange',
					message: '{{ _("This item has options. Please click \"Configure Options\" to select your preferred variant.") }}'
				});
				return;
			}
			
			// Use ACCESSORY manufacturer type internally for items (keeps data model compatibility)
			data.manufacturer_type = 'ACCESSORY';
			data.accessory_product_type = productType;
			
			// If variant was selected, use that; otherwise use the template item
			if (selectedVariant) {
				data.accessory_item = selectedVariant;
				data.accessory_item_name = $('#selected_variant_name').text().split(' (')[0];
			} else {
				data.accessory_item = selectedItem;
				data.accessory_item_name = $selectedOption.data('name') || '';
			}
			
			console.log('Final data.accessory_item:', data.accessory_item);
			console.log('Final data.accessory_item_name:', data.accessory_item_name);
			console.log('Final data.accessory_product_type:', data.accessory_product_type);
		}
	}
	
	console.log('Final data object:', data);
	}

	// Add Other manufacturer fields if applicable
	if (manufacturerType === 'OTHER') {
		data.manufacturer_name = form.find('[name="manufacturer_name"]').val();
		data.fixture_model_number = form.find('[name="fixture_model_number"]').val();
		data.trim_info = form.find('[name="trim_info"]').val();
		data.housing_model_number = form.find('[name="housing_model_number"]').val();
		data.driver_model_number = form.find('[name="driver_model_number"]').val();
		data.lamp_info = form.find('[name="lamp_info"]').val();
		data.dimming_protocol = form.find('[name="dimming_protocol"]').val();
		data.input_voltage = form.find('[name="input_voltage"]').val();
		data.other_finish = form.find('[name="other_finish"]').val();
	}

	// Handle file upload if present
	var fileInput = document.getElementById('add_spec_sheet_file');
	if (manufacturerType === 'OTHER' && fileInput && fileInput.files.length > 0) {
		uploadFile(fileInput, function(fileUrl) {
			if (fileUrl) {
				data.spec_sheet = fileUrl;
			}
			submitAddLine(data);
		});
	} else {
		submitAddLine(data);
	}
}

function submitAddLine(data) {
	frappe.call({
		method: 'illumenate_lighting.illumenate_lighting.api.portal.add_schedule_line',
		args: {
			schedule_name: schedule_name,
			line_data: data
		},
		callback: function(r) {
			if (r.message && r.message.success) {
				$('#addLineModal').modal('hide');
				location.reload();
			} else {
				frappe.msgprint(r.message.error || 'Error adding line');
			}
		}
	});
}

function configureFromAddModal() {
	var form = $('#addLineForm');
	var manufacturerType = form.find('[name="manufacturer_type"]').val();
	var productType = form.find('[name="product_type"]').val();
	
	// Only allow configuring for ILLUMENATE manufacturer with Linear Fixture
	if (manufacturerType !== 'ILLUMENATE' || productType !== 'Linear Fixture') {
		frappe.msgprint('Configure is only available for ilLumenate Linear Fixtures');
		return;
	}

	// Get fixture template
	var fixtureTemplate = form.find('[name="fixture_template"]').val();

	// Validate that fixture template is selected
	if (!fixtureTemplate) {
		frappe.msgprint({
			title: 'Selection Required',
			indicator: 'orange',
			message: 'Please select a Fixture Template before configuring.'
		});
		return;
	}

	// Prepare line data
	var data = {
		line_id: form.find('[name="line_id"]').val(),
		qty: form.find('[name="qty"]').val(),
		location: form.find('[name="location"]').val(),
		manufacturer_type: manufacturerType,
		product_type: productType,
		fixture_template: fixtureTemplate,
		configuration_status: 'Pending',
		notes: form.find('[name="notes"]').val()
	};

	// Disable the configure button to prevent double clicks
	$('#configureFromAddBtn').prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i> Adding line...');

	// Add the line first, then redirect to configure
	frappe.call({
		method: 'illumenate_lighting.illumenate_lighting.api.portal.add_schedule_line',
		args: {
			schedule_name: schedule_name,
			line_data: data
		},
		callback: function(r) {
			if (r.message && r.message.success) {
				// Get the newly added line index
				var newLineIdx = r.message.line_idx;
				
				// Close the modal
				$('#addLineModal').modal('hide');
				
				// Redirect to configure page with schedule, line index, and fixture template
				window.location.href = '/portal/configure?schedule=' + schedule_name + '&line_idx=' + newLineIdx + '&template=' + encodeURIComponent(fixtureTemplate);
			} else {
				frappe.msgprint(r.message.error || 'Error adding line');
				$('#configureFromAddBtn').prop('disabled', false).html('<i class="fa fa-cog"></i> Configure Fixture Now');
			}
		},
		error: function() {
			$('#configureFromAddBtn').prop('disabled', false).html('<i class="fa fa-cog"></i> Configure Fixture Now');
		}
	});
}

function duplicateLine(line_idx) {
	frappe.call({
		method: 'illumenate_lighting.illumenate_lighting.api.portal.duplicate_schedule_line',
		args: {
			schedule_name: schedule_name,
			line_idx: line_idx
		},
		callback: function(r) {
			if (r.message && r.message.success) {
				location.reload();
			} else {
				frappe.msgprint(r.message.error || 'Error duplicating line');
			}
		}
	});
}

// Line data for editing
var lineData = {{ lines_json | tojson if lines_json else '[]' }};

function editLine(line_idx) {
	var line = lineData[line_idx];
	if (!line) {
		frappe.msgprint('Line not found');
		return;
	}

	// Populate the edit form
	$('#edit_line_idx').val(line_idx);
	$('#edit_line_id').val(line.line_id || '');
	$('#edit_qty').val(line.qty || 1);
	$('#edit_location').val(line.location || '');
	$('#edit_notes').val(line.notes || '');
	$('#edit_manufacturer_type').val(line.manufacturer_type || 'ILLUMENATE');

	// Hide all type-specific fields first
	$('.edit-other-fields').hide();
	$('.edit-accessory-fields').hide();

	// Show/hide fields based on manufacturer type
	if (line.manufacturer_type === 'OTHER') {
		$('.edit-other-fields').show();
		$('#edit_manufacturer_name').val(line.manufacturer_name || '');
		$('#edit_fixture_model_number').val(line.fixture_model_number || '');
		$('#edit_trim_info').val(line.trim_info || '');
		$('#edit_housing_model_number').val(line.housing_model_number || '');
		$('#edit_driver_model_number').val(line.driver_model_number || '');
		$('#edit_lamp_info').val(line.lamp_info || '');
		$('#edit_dimming_protocol').val(line.dimming_protocol || '');
		$('#edit_input_voltage').val(line.input_voltage || '');
		$('#edit_other_finish').val(line.other_finish || '');

		// Show current spec sheet if exists
		if (line.spec_sheet) {
			$('#edit_spec_sheet_current').html(
				'<a href="' + line.spec_sheet + '" target="_blank" class="btn btn-sm btn-outline-secondary">' +
				'<i class="fa fa-file-pdf-o"></i> Current Spec Sheet</a>'
			);
		} else {
			$('#edit_spec_sheet_current').html('<span class="text-muted">No spec sheet uploaded</span>');
		}
	} else if (line.manufacturer_type === 'ACCESSORY') {
		$('.edit-accessory-fields').show();
		$('#edit_accessory_product_type').val(line.accessory_product_type || '');
		$('#edit_accessory_item').val((line.accessory_item_name || '') + ' (' + (line.accessory_item || '') + ')');
	}

	$('#editLineModal').modal('show');
}

function saveEditLine() {
	var line_idx = $('#edit_line_idx').val();
	var line = lineData[line_idx];
	var line_data = {
		line_id: $('#edit_line_id').val(),
		qty: $('#edit_qty').val(),
		location: $('#edit_location').val(),
		notes: $('#edit_notes').val()
	};

	// Add Other manufacturer fields if applicable
	if (line && line.manufacturer_type === 'OTHER') {
		line_data.manufacturer_name = $('#edit_manufacturer_name').val();
		line_data.fixture_model_number = $('#edit_fixture_model_number').val();
		line_data.trim_info = $('#edit_trim_info').val();
		line_data.housing_model_number = $('#edit_housing_model_number').val();
		line_data.driver_model_number = $('#edit_driver_model_number').val();
		line_data.lamp_info = $('#edit_lamp_info').val();
		line_data.dimming_protocol = $('#edit_dimming_protocol').val();
		line_data.input_voltage = $('#edit_input_voltage').val();
		line_data.other_finish = $('#edit_other_finish').val();

		// Handle file upload if present
		var fileInput = document.getElementById('edit_spec_sheet_file');
		if (fileInput && fileInput.files.length > 0) {
			uploadFile(fileInput, function(fileUrl) {
				if (fileUrl) {
					line_data.spec_sheet = fileUrl;
				}
				submitEditLine(line_idx, line_data);
			});
			return;
		}
	}

	submitEditLine(line_idx, line_data);
}

function submitEditLine(line_idx, line_data) {
	frappe.call({
		method: 'illumenate_lighting.illumenate_lighting.api.portal.update_schedule_line',
		args: {
			schedule_name: schedule_name,
			line_idx: line_idx,
			line_data: line_data
		},
		callback: function(r) {
			if (r.message && r.message.success) {
				$('#editLineModal').modal('hide');
				location.reload();
			} else {
				frappe.msgprint(r.message.error || 'Error updating line');
			}
		}
	});
}

function deleteLine(line_idx) {
	frappe.confirm('Are you sure you want to delete this line?', function() {
		frappe.call({
			method: 'illumenate_lighting.illumenate_lighting.api.portal.delete_schedule_line',
			args: {
				schedule_name: schedule_name,
				line_idx: line_idx
			},
			callback: function(r) {
				if (r.message && r.message.success) {
					location.reload();
				}
			}
		});
	});
}

function changeStatus(new_status) {
	var statusLabels = {
		'DRAFT': 'Draft',
		'READY': 'Ready',
		'QUOTED': 'Quoted'
	};
	frappe.confirm('Change schedule status to ' + statusLabels[new_status] + '?', function() {
		frappe.call({
			method: 'illumenate_lighting.illumenate_lighting.api.portal.update_schedule_status',
			args: {
				schedule_name: schedule_name,
				new_status: new_status
			},
			callback: function(r) {
				if (r.message && r.message.success) {
					frappe.show_alert({
						message: 'Status updated to ' + new_status,
						indicator: 'green'
					});
					location.reload();
				} else {
					frappe.msgprint({
						title: 'Error',
						indicator: 'red',
						message: r.message.error || 'Error updating status'
					});
				}
			}
		});
	});
}

function requestQuote() {
	frappe.confirm('Request a quote for this schedule?', function() {
		frappe.call({
			method: 'illumenate_lighting.illumenate_lighting.api.portal.request_schedule_quote',
			args: {
				schedule_name: schedule_name
			},
			callback: function(r) {
				if (r.message && r.message.success) {
					frappe.msgprint({
						title: 'Success',
						indicator: 'green',
						message: 'Quote requested successfully'
					});
					location.reload();
				} else {
					frappe.msgprint(r.message.error || 'Error requesting quote');
				}
			}
		});
	});
}

function createSalesOrder() {
	frappe.confirm('Create a Sales Order from this schedule?', function() {
		frappe.call({
			method: 'illumenate_lighting.illumenate_lighting.api.portal.create_schedule_sales_order',
			args: {
				schedule_name: schedule_name
			},
			callback: function(r) {
				if (r.message && r.message.success) {
					frappe.msgprint('Sales Order ' + r.message.sales_order + ' created successfully');
					location.reload();
				} else {
					frappe.msgprint(r.message.error || 'Error creating Sales Order');
				}
			}
		});
	});
}

// Export functionality
function generateExport(format, priced) {
	var method = format === 'pdf'
		? 'illumenate_lighting.illumenate_lighting.api.exports.generate_schedule_pdf'
		: 'illumenate_lighting.illumenate_lighting.api.exports.generate_schedule_csv';

	frappe.show_alert({
		message: 'Generating ' + format.toUpperCase() + ' export...',
		indicator: 'blue'
	});

	frappe.call({
		method: method,
		args: {
			schedule_id: schedule_name,
			priced: priced
		},
		callback: function(r) {
			if (r.message && r.message.success) {
				frappe.show_alert({
					message: 'Export generated successfully!',
					indicator: 'green'
				});
				// Refresh export history
				loadExportHistory();
				// Open download in new tab
				if (r.message.download_url) {
					window.open(r.message.download_url, '_blank');
				}
			} else {
				frappe.msgprint({
					title: 'Export Error',
					indicator: 'red',
					message: r.message.error || 'Error generating export'
				});
			}
		},
		error: function() {
			frappe.msgprint({
				title: 'Export Error',
				indicator: 'red',
				message: 'Error generating export'
			});
		}
	});
}

function loadExportHistory() {
	frappe.call({
		method: 'illumenate_lighting.illumenate_lighting.api.exports.get_export_history',
		args: {
			schedule_id: schedule_name
		},
		callback: function(r) {
			if (r.message && r.message.success) {
				renderExportHistory(r.message.exports);
			} else {
				$('#exportHistoryContainer').html(
					'<div class="text-center text-muted py-3">' +
					'<i class="fa fa-exclamation-circle"></i> ' +
					(r.message.error || 'Error loading export history') +
					'</div>'
				);
			}
		}
	});
}

function renderExportHistory(exports) {
	if (!exports || exports.length === 0) {
		$('#exportHistoryContainer').html(
			'<div class="text-center text-muted py-3">' +
			'<i class="fa fa-download"></i> No exports yet. Use the buttons above to generate exports.' +
			'</div>'
		);
		return;
	}

	var html = '<div class="table-responsive"><table class="table table-hover mb-0">';
	html += '<thead class="thead-light"><tr>';
	html += '<th>Type</th>';
	html += '<th>Status</th>';
	html += '<th>Requested By</th>';
	html += '<th>Created</th>';
	html += '<th>Download</th>';
	html += '</tr></thead><tbody>';

	exports.forEach(function(exp) {
		var statusClass = {
			'QUEUED': 'warning',
			'RUNNING': 'info',
			'COMPLETE': 'success',
			'FAILED': 'danger'
		}[exp.status] || 'secondary';

		var typeLabel = exp.export_type.replace('_', ' ');
		var createdOn = exp.created_on ? frappe.datetime.prettyDate(exp.created_on) : '-';

		html += '<tr>';
		html += '<td>' + typeLabel + '</td>';
		html += '<td><span class="badge badge-' + statusClass + '">' + exp.status + '</span></td>';
		html += '<td>' + (exp.requested_by_name || '-') + '</td>';
		html += '<td>' + createdOn + '</td>';
		html += '<td>';
		if (exp.status === 'COMPLETE' && exp.output_file) {
			html += '<a href="' + exp.output_file + '" target="_blank" class="btn btn-sm btn-outline-primary">';
			html += '<i class="fa fa-download"></i> Download</a>';
		} else if (exp.status === 'FAILED') {
			html += '<span class="text-danger"><i class="fa fa-times"></i> Failed</span>';
		} else {
			html += '<span class="text-muted"><i class="fa fa-clock-o"></i> Pending</span>';
		}
		html += '</td>';
		html += '</tr>';
	});

	html += '</tbody></table></div>';
	$('#exportHistoryContainer').html(html);
}

// Load export history on page load
$(document).ready(function() {
	loadExportHistory();
});
{% endif %}
</script>
{% endblock %}
