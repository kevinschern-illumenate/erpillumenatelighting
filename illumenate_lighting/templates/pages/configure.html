{#
Portal Configurator Page
Allows users to configure fixtures using segment-based configuration
#}
{% extends "templates/web.html" %}

{% block title %}{{ _("Configure Fixture") }}{% endblock %}

{% block style %}
<style>
.segment-card {
	border: 1px solid #dee2e6;
	border-radius: 0.25rem;
	margin-bottom: 0.5rem;
}
.segment-card .card-header {
	background-color: #f8f9fa;
	padding: 0.5rem 1rem;
}
.segment-card .card-body {
	padding: 0.75rem 1rem;
}
.segment-inherited {
	background-color: #e9ecef;
	padding: 0.25rem 0.5rem;
	border-radius: 0.25rem;
	font-size: 0.85rem;
	color: #6c757d;
}
.segment-inherited i {
	margin-right: 0.25rem;
}
.end-type-toggle {
	display: flex;
	gap: 0.5rem;
}
.end-type-toggle .btn {
	flex: 1;
}
.end-type-toggle .btn.active {
	background-color: #0d6efd;
	color: white;
}
.jumper-fields, .endcap-fields {
	padding: 0.5rem;
	background: #f8f9fa;
	border-radius: 0.25rem;
	margin-top: 0.5rem;
}
</style>
{% endblock %}

{% block page_content %}
<div class="container portal-page">
	<!-- Breadcrumb -->
	<nav aria-label="breadcrumb" class="mb-4">
		<ol class="breadcrumb">
			<li class="breadcrumb-item"><a href="/portal/projects">{{ _("Projects") }}</a></li>
			{% if schedule %}
			<li class="breadcrumb-item"><a href="/portal/schedules/{{ schedule.name }}">{{ schedule.schedule_name }}</a></li>
			{% endif %}
			<li class="breadcrumb-item active" aria-current="page">{{ _("Configure Fixture") }}</li>
		</ol>
	</nav>

	<div class="row">
		<!-- Configurator Form -->
		<div class="col-lg-7">
			<div class="card mb-3">
				<div class="card-header">
					<h5 class="mb-0">{{ _("Fixture Configuration") }}</h5>
				</div>
				<div class="card-body">
					<form id="configuratorForm">
						<!-- Template Selection -->
						<div class="form-group">
							<label>{{ _("Fixture Template") }} <span class="text-danger">*</span></label>
							<select class="form-control" name="fixture_template_code" required>
								<option value="">{{ _("Select Template...") }}</option>
								{% for template in templates %}
								<option value="{{ template.template_code }}" {% if template.template_code == selected_template %}selected{% endif %}>
									{{ template.template_name }} ({{ template.template_code }})
								</option>
								{% endfor %}
							</select>
						</div>

						<!-- Options loaded dynamically based on template -->
						<div id="templateOptions" style="display: none;">
							<hr>
							<h6 class="mb-3">{{ _("Options") }}</h6>

							<div class="row">
								<div class="col-md-6">
									<div class="form-group">
										<label>{{ _("Finish") }} <span class="text-danger">*</span></label>
										<select class="form-control" name="finish_code" required></select>
									</div>
								</div>
								<div class="col-md-6">
									<div class="form-group">
										<label>{{ _("Lens Appearance") }} <span class="text-danger">*</span></label>
										<select class="form-control" name="lens_appearance_code" required></select>
									</div>
								</div>
							</div>

							<div class="row">
								<div class="col-md-6">
									<div class="form-group">
										<label>{{ _("Mounting Method") }} <span class="text-danger">*</span></label>
										<select class="form-control" name="mounting_method_code" required></select>
									</div>
								</div>
								<div class="col-md-6">
									<div class="form-group">
										<label>{{ _("Endcap Color") }} <span class="text-danger">*</span></label>
										<select class="form-control" name="endcap_color_code" required></select>
									</div>
								</div>
							</div>

							<div class="row">
								<div class="col-md-6">
									<div class="form-group">
										<label>{{ _("Environment Rating") }} <span class="text-danger">*</span></label>
										<select class="form-control" name="environment_rating_code" required></select>
									</div>
								</div>
								<div class="col-md-6">
									<div class="form-group">
										<label>{{ _("Tape Offering") }} <span class="text-danger">*</span></label>
										<select class="form-control" name="tape_offering_id" required></select>
									</div>
								</div>
							</div>
						</div>
					</form>
				</div>
			</div>

			<!-- Segments Card -->
			<div class="card mb-3" id="segmentsCard" style="display: none;">
				<div class="card-header d-flex justify-content-between align-items-center">
					<h5 class="mb-0">{{ _("Fixture Segments") }}</h5>
					<span class="badge badge-info" id="segmentCountBadge">0 {{ _("segments") }}</span>
				</div>
				<div class="card-body">
					<p class="text-muted small mb-3">
						{{ _("Define each segment of your fixture. The first segment starts with a leader cable. Connect segments with jumper cables, or cap the fixture with an endcap.") }}
					</p>
					<div id="segmentsList"></div>
					
					<div id="addSegmentHint" class="text-center py-3 text-muted" style="display: none;">
						<i class="fa fa-arrow-up"></i> {{ _("Select Jumper on the last segment's end to add another segment") }}
					</div>
				</div>
			</div>

			<!-- Action Buttons -->
			<div class="d-flex justify-content-between" id="actionButtons" style="display: none;">
				<button type="button" class="btn btn-primary" id="calculateBtn" onclick="validateAndQuote()" disabled>
					<i class="fa fa-calculator"></i> {{ _("Calculate & Validate") }}
				</button>
				{% if can_save %}
				<button type="button" class="btn btn-success" id="saveBtn" onclick="saveToSchedule()" disabled>
					<i class="fa fa-save"></i> {{ _("Add to Schedule") }}
				</button>
				{% endif %}
			</div>
		</div>

		<!-- Results Panel -->
		<div class="col-lg-5">
			<div class="card">
				<div class="card-header d-flex justify-content-between align-items-center">
					<h5 class="mb-0">{{ _("Results") }}</h5>
					<span id="validationStatus" class="badge badge-secondary">{{ _("Not Calculated") }}</span>
				</div>
				<div class="card-body">
					<!-- Messages -->
					<div id="messagesPanel" style="display: none;">
						<h6>{{ _("Messages") }}</h6>
						<div id="messagesList"></div>
						<hr>
					</div>

					<!-- Length Results -->
					<div id="lengthResults" style="display: none;">
						<h6>{{ _("Length Summary") }}</h6>
						<table class="table table-sm">
							<tr>
								<td>{{ _("Total Requested Length") }}</td>
								<td class="text-right"><span id="requestedLength">-</span></td>
							</tr>
							<tr>
								<td>{{ _("Total Manufacturable Length") }}</td>
								<td class="text-right"><strong><span id="mfgLength">-</span></strong></td>
							</tr>
							<tr>
								<td>{{ _("Segment Count") }}</td>
								<td class="text-right"><span id="segmentCountResult">-</span></td>
							</tr>
						</table>
						<hr>
					</div>

					<!-- Manufacturing Summary -->
					<div id="manufacturingResults" style="display: none;">
						<h6>{{ _("Manufacturing Summary") }}</h6>
						<table class="table table-sm">
							<tr>
								<td>{{ _("Profile/Lens Segments") }}</td>
								<td class="text-right"><span id="profileSegmentsCount">-</span></td>
							</tr>
							<tr>
								<td>{{ _("LED Tape Runs") }}</td>
								<td class="text-right"><span id="runsCount">-</span></td>
							</tr>
							<tr>
								<td>{{ _("Endcaps") }}</td>
								<td class="text-right"><span id="endcapsCount">-</span></td>
							</tr>
							<tr>
								<td>{{ _("Mounting Accessories") }}</td>
								<td class="text-right"><span id="mountingCount">-</span></td>
							</tr>
							<tr>
								<td>{{ _("Total Watts") }}</td>
								<td class="text-right"><span id="totalWatts">-</span></td>
							</tr>
							<tr>
								<td>{{ _("Assembly Mode") }}</td>
								<td class="text-right"><span id="assemblyMode">-</span></td>
							</tr>
						</table>
						<hr>
					</div>

					<!-- Build Description -->
					<div id="buildDescriptionPanel" style="display: none;">
						<h6>{{ _("Build Description") }}</h6>
						<div id="buildDescription" class="small bg-light p-2 rounded" style="white-space: pre-wrap;"></div>
						<hr>
					</div>

					<!-- Driver Plan -->
					<div id="driverResults" style="display: none;">
						<h6>{{ _("Driver Plan") }}</h6>
						<div id="driverPlan"></div>
						<hr>
					</div>

					<!-- Pricing -->
					{% if show_pricing %}
					<div id="pricingResults" style="display: none;">
						<h6>{{ _("Pricing") }}</h6>
						<table class="table table-sm">
							<tr>
								<td>{{ _("MSRP (Unit)") }}</td>
								<td class="text-right"><strong><span id="msrpUnit">-</span></strong></td>
							</tr>
							<tr>
								<td>{{ _("Tier Price (Unit)") }}</td>
								<td class="text-right"><span id="tierUnit">-</span></td>
							</tr>
						</table>
						<div id="adderBreakdown"></div>
					</div>
					{% endif %}

					<div id="noResults" class="text-center py-4">
						<i class="fa fa-calculator fa-3x text-muted mb-3"></i>
						<p class="text-muted">{{ _("Configure segments and click 'Calculate & Validate' to see results") }}</p>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<!-- Segment Template -->
<template id="segmentTemplate">
	<div class="segment-card" data-segment-index="">
		<div class="card-header d-flex justify-content-between align-items-center">
			<strong>{{ _("Segment") }} <span class="segment-number"></span></strong>
			<button type="button" class="btn btn-sm btn-outline-danger remove-segment-btn" onclick="removeSegment(this)" style="display: none;">
				<i class="fa fa-trash"></i>
			</button>
		</div>
		<div class="card-body">
			<!-- Start Section (for first segment or inherited from prior) -->
			<div class="segment-start mb-3">
				<div class="row">
					<div class="col-12">
						<label class="small font-weight-bold">{{ _("Segment Start") }}</label>
					</div>
				</div>
				<!-- First segment: user selects power feed type and leader cable length -->
				<div class="first-segment-start" style="display: none;">
					<div class="row">
						<div class="col-md-6">
							<div class="form-group mb-2">
								<label class="small">{{ _("Power Feed Type") }} <span class="text-danger">*</span></label>
								<select class="form-control form-control-sm" name="start_power_feed_type"></select>
							</div>
						</div>
						<div class="col-md-6">
							<div class="form-group mb-2">
								<label class="small">{{ _("Leader Cable Length (mm)") }}</label>
								<input type="number" class="form-control form-control-sm" name="start_leader_cable_length_mm" value="300" min="0">
							</div>
						</div>
					</div>
				</div>
				<!-- Subsequent segments: inherited from prior segment -->
				<div class="inherited-start segment-inherited" style="display: none;">
					<i class="fa fa-link"></i> <span class="inherited-text">{{ _("Inherited from prior segment") }}</span>
				</div>
			</div>

			<!-- Segment Length -->
			<div class="segment-length mb-3">
				<div class="row">
					<div class="col-md-6">
						<div class="form-group mb-2">
							<label class="small font-weight-bold">{{ _("Requested Length") }} <span class="text-danger">*</span></label>
							<input type="number" class="form-control" name="requested_length_mm" min="1" step="0.1" required placeholder="e.g., 48">
						</div>
					</div>
					<div class="col-md-6">
						<div class="form-group mb-2">
							<label class="small">{{ _("Unit") }}</label>
							<select class="form-control" name="length_unit">
								<option value="in" selected>inches</option>
								<option value="ft_in">feet + inches</option>
								<option value="mm">mm</option>
							</select>
						</div>
					</div>
				</div>
				<!-- Feet + Inches input (shown when unit is ft_in) -->
				<div class="row feet-inches-row" style="display: none;">
					<div class="col-md-4">
						<div class="form-group mb-2">
							<label class="small">{{ _("Feet") }}</label>
							<input type="number" class="form-control form-control-sm" name="length_feet" min="0" value="0">
						</div>
					</div>
					<div class="col-md-4">
						<div class="form-group mb-2">
							<label class="small">{{ _("Inches") }}</label>
							<input type="number" class="form-control form-control-sm" name="length_inches" min="0" max="11.99" step="0.1" value="0">
						</div>
					</div>
				</div>
			</div>

			<!-- End Section -->
			<div class="segment-end">
				<div class="row">
					<div class="col-12">
						<label class="small font-weight-bold">{{ _("Segment End") }}</label>
					</div>
				</div>
				<div class="end-type-toggle mb-2">
					<button type="button" class="btn btn-outline-secondary btn-sm end-type-btn" data-type="Endcap" onclick="setEndType(this, 'Endcap')">
						<i class="fa fa-stop-circle"></i> {{ _("Endcap (Cap Fixture)") }}
					</button>
					<button type="button" class="btn btn-outline-secondary btn-sm end-type-btn" data-type="Jumper" onclick="setEndType(this, 'Jumper')">
						<i class="fa fa-link"></i> {{ _("Jumper (Continue to Next)") }}
					</button>
				</div>
				<input type="hidden" name="end_type" value="Endcap">

				<!-- Endcap Fields (shown when end type is Endcap) -->
				<div class="endcap-fields" style="display: none;">
					<div class="small text-muted">
						<i class="fa fa-info-circle"></i> {{ _("Fixture will be capped with a solid endcap") }}
					</div>
				</div>

				<!-- Jumper Fields (shown when end type is Jumper) -->
				<div class="jumper-fields" style="display: none;">
					<div class="row">
						<div class="col-md-6">
							<div class="form-group mb-2">
								<label class="small">{{ _("Power Feed Type") }} <span class="text-danger">*</span></label>
								<select class="form-control form-control-sm" name="end_power_feed_type"></select>
							</div>
						</div>
						<div class="col-md-6">
							<div class="form-group mb-2">
								<label class="small">{{ _("Jumper Cable Length (mm)") }}</label>
								<input type="number" class="form-control form-control-sm" name="end_jumper_cable_length_mm" value="300" min="0">
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</template>
{% endblock %}

{% block script %}
<script>
var schedule_name = "{{ schedule.name if schedule else '' }}";
var line_idx = {{ line_idx if line_idx is not none else 'null' }};
var currentResult = null;
var templateOptions = null;
var segmentCount = 0;
var MM_PER_INCH = 25.4;
var MM_PER_FOOT = 304.8;
var INCHES_PER_FOOT = 12;

// Load template options when template is selected
$('select[name="fixture_template_code"]').on('change', function() {
	var template = $(this).val();
	if (template) {
		loadTemplateOptions(template);
		$('#templateOptions').show();
		$('#segmentsCard').show();
		$('#actionButtons').show();
		// Initialize first segment if none exist
		if (segmentCount === 0) {
			addSegment(true);
		}
	} else {
		$('#templateOptions').hide();
		$('#segmentsCard').hide();
		$('#actionButtons').hide();
	}
});

function loadTemplateOptions(template_code) {
	frappe.call({
		method: 'illumenate_lighting.illumenate_lighting.api.portal.get_template_options',
		args: { template_code: template_code },
		callback: function(r) {
			if (r.message) {
				templateOptions = r.message;
				populateOptions(r.message);
				// Populate power feed options in existing segments
				$('.segment-card').each(function() {
					populateSegmentPowerFeedOptions($(this));
				});
			}
		}
	});
}

function populateOptions(options) {
	// Populate base options
	var fields = ['finish', 'lens_appearance', 'mounting_method', 'environment_rating'];
	fields.forEach(function(field) {
		var select = $('select[name="' + field + '_code"]');
		select.empty().append('<option value="">Select...</option>');
		if (options[field]) {
			options[field].forEach(function(opt) {
				select.append('<option value="' + opt.value + '">' + opt.label + '</option>');
			});
		}
	});

	// Populate tape offerings
	var tapeSelect = $('select[name="tape_offering_id"]');
	tapeSelect.empty().append('<option value="">Select...</option>');
	if (options.tape_offerings) {
		options.tape_offerings.forEach(function(opt) {
			tapeSelect.append('<option value="' + opt.value + '">' + opt.label + '</option>');
		});
	}

	// Populate endcap colors
	var colorSelect = $('select[name="endcap_color_code"]');
	colorSelect.empty().append('<option value="">Select...</option>');
	if (options.endcap_colors) {
		options.endcap_colors.forEach(function(opt) {
			colorSelect.append('<option value="' + opt.value + '">' + opt.label + '</option>');
		});
	}
}

function populateSegmentPowerFeedOptions(segmentCard) {
	if (!templateOptions || !templateOptions.power_feed_type) return;
	
	['start_power_feed_type', 'end_power_feed_type'].forEach(function(fieldName) {
		var select = segmentCard.find('[name="' + fieldName + '"]');
		select.empty().append('<option value="">Select...</option>');
		templateOptions.power_feed_type.forEach(function(opt) {
			select.append('<option value="' + opt.value + '">' + opt.label + '</option>');
		});
	});
}

function addSegment(isFirst) {
	segmentCount++;
	var template = document.getElementById('segmentTemplate');
	var clone = template.content.cloneNode(true);
	var card = clone.querySelector('.segment-card');
	
	card.dataset.segmentIndex = segmentCount;
	card.querySelector('.segment-number').textContent = segmentCount;
	
	if (isFirst) {
		// First segment: show power feed type and leader cable selection
		card.querySelector('.first-segment-start').style.display = 'block';
		card.querySelector('.inherited-start').style.display = 'none';
	} else {
		// Subsequent segments: show inherited from prior
		card.querySelector('.first-segment-start').style.display = 'none';
		card.querySelector('.inherited-start').style.display = 'block';
		// Can be removed
		card.querySelector('.remove-segment-btn').style.display = 'inline-block';
		
		// Copy power feed and jumper length from prior segment's end
		var priorSegment = $('#segmentsList .segment-card').last();
		if (priorSegment.length) {
			var priorEndPFT = priorSegment.find('[name="end_power_feed_type"]').val();
			var priorJumperLen = priorSegment.find('[name="end_jumper_cable_length_mm"]').val();
			
			// Store inherited values as data attributes
			card.dataset.inheritedPowerFeedType = priorEndPFT || '';
			card.dataset.inheritedCableLength = priorJumperLen || '300';
			
			// Update inherited text
			var inheritedText = 'From prior segment: ' + (priorEndPFT || 'N/A') + ', ' + (priorJumperLen || '300') + 'mm jumper';
			card.querySelector('.inherited-text').textContent = inheritedText;
		}
	}
	
	document.getElementById('segmentsList').appendChild(clone);
	
	var segmentCard = $('#segmentsList .segment-card').last();
	if (templateOptions) {
		populateSegmentPowerFeedOptions(segmentCard);
	}
	
	// Set default end type to Endcap
	setEndType(segmentCard.find('.end-type-btn[data-type="Endcap"]')[0], 'Endcap');
	
	// Setup unit change handler for length conversion
	setupUnitChangeHandler(segmentCard);
	
	updateUI();
}

function removeSegment(btn) {
	var card = $(btn).closest('.segment-card');
	var index = parseInt(card.data('segment-index'));
	
	// Only allow removing if it's not the first segment
	if (index <= 1) {
		frappe.msgprint('Cannot remove the first segment');
		return;
	}
	
	// Remove this segment and all following segments
	var segmentsToRemove = [];
	$('.segment-card').each(function() {
		if (parseInt($(this).data('segment-index')) >= index) {
			segmentsToRemove.push($(this));
		}
	});
	
	segmentsToRemove.forEach(function(s) {
		s.remove();
		segmentCount--;
	});
	
	// Update the prior segment's end type to Endcap
	var lastSegment = $('#segmentsList .segment-card').last();
	if (lastSegment.length) {
		setEndType(lastSegment.find('.end-type-btn[data-type="Endcap"]')[0], 'Endcap');
	}
	
	updateUI();
}

function setEndType(btn, type) {
	var card = $(btn).closest('.segment-card');
	var endTypeInput = card.find('[name="end_type"]');
	
	// Update button states
	card.find('.end-type-btn').removeClass('active btn-primary').addClass('btn-outline-secondary');
	$(btn).removeClass('btn-outline-secondary').addClass('active btn-primary');
	
	endTypeInput.val(type);
	
	if (type === 'Endcap') {
		card.find('.endcap-fields').show();
		card.find('.jumper-fields').hide();
		
		// Remove any segments after this one
		var currentIndex = parseInt(card.data('segment-index'));
		var segmentsToRemove = [];
		$('.segment-card').each(function() {
			if (parseInt($(this).data('segment-index')) > currentIndex) {
				segmentsToRemove.push($(this));
			}
		});
		segmentsToRemove.forEach(function(s) {
			s.remove();
			segmentCount--;
		});
		
		$('#addSegmentHint').hide();
	} else {
		// Jumper
		card.find('.endcap-fields').hide();
		card.find('.jumper-fields').show();
		
		// Auto-add next segment if this is the last one
		var currentIndex = parseInt(card.data('segment-index'));
		var hasNextSegment = false;
		$('.segment-card').each(function() {
			if (parseInt($(this).data('segment-index')) > currentIndex) {
				hasNextSegment = true;
			}
		});
		
		if (!hasNextSegment) {
			// Wait a moment then add the next segment
			setTimeout(function() {
				addSegment(false);
			}, 100);
		}
	}
	
	updateUI();
}

function convertSegmentLength(segmentCard, newUnit, oldUnit) {
	var lengthInput = segmentCard.find('[name="requested_length_mm"]');
	var feetInchesRow = segmentCard.find('.feet-inches-row');
	var feetInput = segmentCard.find('[name="length_feet"]');
	var inchesInput = segmentCard.find('[name="length_inches"]');
	
	// First, get current value in mm
	var currentMm = 0;
	if (oldUnit === 'mm') {
		currentMm = parseFloat(lengthInput.val()) || 0;
	} else if (oldUnit === 'in') {
		currentMm = (parseFloat(lengthInput.val()) || 0) * MM_PER_INCH;
	} else if (oldUnit === 'ft_in') {
		var feet = parseFloat(feetInput.val()) || 0;
		var inches = parseFloat(inchesInput.val()) || 0;
		currentMm = (feet * INCHES_PER_FOOT + inches) * MM_PER_INCH;
	}
	
	// Now convert to new unit
	if (newUnit === 'mm') {
		lengthInput.val(Math.round(currentMm));
		lengthInput.closest('.form-group').show();
		feetInchesRow.hide();
	} else if (newUnit === 'in') {
		lengthInput.val((currentMm / MM_PER_INCH).toFixed(2));
		lengthInput.closest('.form-group').show();
		feetInchesRow.hide();
	} else if (newUnit === 'ft_in') {
		// Hide the single input, show feet+inches
		lengthInput.closest('.form-group').hide();
		feetInchesRow.show();
		
		var totalInches = currentMm / MM_PER_INCH;
		var feet = Math.floor(totalInches / INCHES_PER_FOOT);
		var inches = totalInches % INCHES_PER_FOOT;
		feetInput.val(feet);
		inchesInput.val(inches.toFixed(2));
	}
}

function setupUnitChangeHandler(segmentCard) {
	var unitSelect = segmentCard.find('[name="length_unit"]');
	// Store current unit in data attribute for persistence
	unitSelect.data('lastUnit', unitSelect.val());
	
	unitSelect.on('change', function() {
		var newUnit = $(this).val();
		var lastUnit = $(this).data('lastUnit') || 'in';
		convertSegmentLength(segmentCard, newUnit, lastUnit);
		$(this).data('lastUnit', newUnit);
	});
	
	// Initialize feet+inches row visibility
	var currentUnit = unitSelect.val();
	if (currentUnit === 'ft_in') {
		segmentCard.find('[name="requested_length_mm"]').closest('.form-group').hide();
		segmentCard.find('.feet-inches-row').show();
	} else {
		segmentCard.find('.feet-inches-row').hide();
	}
}

function updateUI() {
	// Update segment count badge
	$('#segmentCountBadge').text(segmentCount + ' segment' + (segmentCount !== 1 ? 's' : ''));
	
	// Check if fixture is complete (last segment ends with Endcap)
	var lastSegment = $('#segmentsList .segment-card').last();
	var isComplete = lastSegment.length && lastSegment.find('[name="end_type"]').val() === 'Endcap';
	
	// Enable/disable calculate button based on completeness
	$('#calculateBtn').prop('disabled', !isComplete);
	
	// Update segment numbers
	$('.segment-card').each(function(index) {
		$(this).attr('data-segment-index', index + 1);
		$(this).find('.segment-number').text(index + 1);
		
		// Show/hide remove button (can't remove first segment)
		if (index === 0) {
			$(this).find('.remove-segment-btn').hide();
		} else {
			$(this).find('.remove-segment-btn').show();
		}
	});
	
	// Update inherited values display
	$('.segment-card').each(function(index) {
		if (index > 0) {
			var priorSegment = $('.segment-card').eq(index - 1);
			var priorEndPFT = priorSegment.find('[name="end_power_feed_type"]').val();
			var priorJumperLen = priorSegment.find('[name="end_jumper_cable_length_mm"]').val();
			
			$(this)[0].dataset.inheritedPowerFeedType = priorEndPFT || '';
			$(this)[0].dataset.inheritedCableLength = priorJumperLen || '300';
			
			var inheritedText = 'From prior: ' + (priorEndPFT || 'N/A') + ', ' + (priorJumperLen || '300') + 'mm';
			$(this).find('.inherited-text').text(inheritedText);
		}
	});
	
	segmentCount = $('.segment-card').length;
}

function collectSegments() {
	var segments = [];
	$('.segment-card').each(function(index) {
		var card = $(this);
		
		// Get length in mm based on unit
		var length = 0;
		var unit = card.find('[name="length_unit"]').val();
		if (unit === 'mm') {
			length = parseFloat(card.find('[name="requested_length_mm"]').val()) || 0;
		} else if (unit === 'in') {
			length = Math.round((parseFloat(card.find('[name="requested_length_mm"]').val()) || 0) * MM_PER_INCH);
		} else if (unit === 'ft_in') {
			var feet = parseFloat(card.find('[name="length_feet"]').val()) || 0;
			var inches = parseFloat(card.find('[name="length_inches"]').val()) || 0;
			length = Math.round((feet * INCHES_PER_FOOT + inches) * MM_PER_INCH);
		}
		
		var segment = {
			segment_index: index + 1,
			requested_length_mm: length,
			end_type: card.find('[name="end_type"]').val()
		};
		
		if (index === 0) {
			// First segment: get start power feed and leader cable
			segment.start_power_feed_type = card.find('[name="start_power_feed_type"]').val();
			segment.start_leader_cable_length_mm = parseInt(card.find('[name="start_leader_cable_length_mm"]').val()) || 300;
		} else {
			// Inherited from prior segment
			segment.start_power_feed_type = card[0].dataset.inheritedPowerFeedType || '';
			segment.start_leader_cable_length_mm = parseInt(card[0].dataset.inheritedCableLength) || 300;
		}
		
		if (segment.end_type === 'Jumper') {
			segment.end_power_feed_type = card.find('[name="end_power_feed_type"]').val();
			segment.end_jumper_cable_length_mm = parseInt(card.find('[name="end_jumper_cable_length_mm"]').val()) || 300;
		}
		
		segments.push(segment);
	});
	return segments;
}

function validateAndQuote() {
	var form = $('#configuratorForm');
	var segments = collectSegments();
	
	if (segments.length === 0) {
		frappe.msgprint('Please add at least one segment');
		return;
	}
	
	// Check if last segment ends with Endcap
	var lastSegment = segments[segments.length - 1];
	if (lastSegment.end_type !== 'Endcap') {
		frappe.msgprint('The fixture must end with an Endcap. Please select Endcap on the last segment.');
		return;
	}
	
	var data = {
		fixture_template_code: form.find('[name="fixture_template_code"]').val(),
		finish_code: form.find('[name="finish_code"]').val(),
		lens_appearance_code: form.find('[name="lens_appearance_code"]').val(),
		mounting_method_code: form.find('[name="mounting_method_code"]').val(),
		endcap_color_code: form.find('[name="endcap_color_code"]').val(),
		environment_rating_code: form.find('[name="environment_rating_code"]').val(),
		tape_offering_id: form.find('[name="tape_offering_id"]').val(),
		segments_json: JSON.stringify(segments)
	};
	
	frappe.call({
		method: 'illumenate_lighting.illumenate_lighting.api.configurator_engine.validate_and_quote_multisegment',
		args: data,
		callback: function(r) {
			if (r.message) {
				currentResult = r.message;
				displayResults(r.message);
			}
		}
	});
}

function displayResults(result) {
	$('#noResults').hide();
	
	// Update validation status
	var statusBadge = $('#validationStatus');
	if (result.is_valid) {
		statusBadge.removeClass('badge-secondary badge-danger').addClass('badge-success').text('Valid');
		$('#saveBtn').prop('disabled', false);
	} else {
		statusBadge.removeClass('badge-secondary badge-success').addClass('badge-danger').text('Invalid');
		$('#saveBtn').prop('disabled', true);
	}
	
	// Display messages
	if (result.messages && result.messages.length > 0) {
		$('#messagesPanel').show();
		var messagesList = $('#messagesList').empty();
		result.messages.forEach(function(msg) {
			var alertClass = msg.severity === 'error' ? 'danger' : (msg.severity === 'warning' ? 'warning' : 'info');
			messagesList.append('<div class="alert alert-' + alertClass + ' py-2 mb-1">' + msg.text + '</div>');
		});
	} else {
		$('#messagesPanel').hide();
	}
	
	// Display length results
	if (result.computed) {
		$('#lengthResults').show();
		$('#requestedLength').text(result.computed.total_requested_length_mm + ' mm');
		$('#mfgLength').text(result.computed.manufacturable_overall_length_mm + ' mm');
		$('#segmentCountResult').text(result.computed.user_segment_count);
		
		$('#manufacturingResults').show();
		$('#profileSegmentsCount').text(result.computed.segments_count);
		$('#runsCount').text(result.computed.runs_count);
		$('#endcapsCount').text(result.computed.total_endcaps);
		$('#mountingCount').text(result.computed.total_mounting_accessories);
		$('#totalWatts').text(result.computed.total_watts + ' W');
		$('#assemblyMode').text(result.computed.assembly_mode);
		
		// Display build description
		if (result.computed.build_description) {
			$('#buildDescriptionPanel').show();
			$('#buildDescription').text(result.computed.build_description);
		}
	}
	
	// Display driver plan
	if (result.resolved_items && result.resolved_items.driver_plan) {
		var dp = result.resolved_items.driver_plan;
		$('#driverResults').show();
		if (dp.status === 'selected' && dp.drivers && dp.drivers.length > 0) {
			var driverHtml = '<table class="table table-sm">';
			dp.drivers.forEach(function(d) {
				driverHtml += '<tr><td>' + d.item_code + '</td><td>Ã—' + d.qty + '</td></tr>';
			});
			driverHtml += '</table>';
			$('#driverPlan').html(driverHtml);
		} else {
			$('#driverPlan').html('<span class="text-muted">' + dp.status + '</span>');
		}
	}
	
	// Display pricing
	if (result.pricing) {
		$('#pricingResults').show();
		$('#msrpUnit').text('$' + result.pricing.msrp_unit.toFixed(2));
		$('#tierUnit').text('$' + result.pricing.tier_unit.toFixed(2));
		
		if (result.pricing.adder_breakdown && result.pricing.adder_breakdown.length > 0) {
			var breakdownHtml = '<details><summary class="text-muted">Price Breakdown</summary><table class="table table-sm mt-2">';
			result.pricing.adder_breakdown.forEach(function(adder) {
				breakdownHtml += '<tr><td>' + adder.component + '</td><td class="text-right">$' + adder.amount.toFixed(2) + '</td></tr>';
			});
			breakdownHtml += '</table></details>';
			$('#adderBreakdown').html(breakdownHtml);
		}
	}
}

function saveToSchedule() {
	if (!currentResult || !currentResult.is_valid || !schedule_name) {
		frappe.msgprint('Cannot save: configuration is not valid or no schedule specified');
		return;
	}
	
	frappe.call({
		method: 'illumenate_lighting.illumenate_lighting.api.portal.save_configured_fixture_to_schedule',
		args: {
			schedule_name: schedule_name,
			line_idx: line_idx,
			configured_fixture_id: currentResult.configured_fixture_id,
			manufacturable_length_mm: currentResult.computed.manufacturable_overall_length_mm
		},
		callback: function(r) {
			if (r.message && r.message.success) {
				frappe.msgprint({
					title: 'Success',
					indicator: 'green',
					message: 'Configuration saved to schedule'
				});
				// Redirect back to schedule
				window.location.href = '/portal/schedules/' + schedule_name;
			} else {
				frappe.msgprint(r.message.error || 'Error saving configuration');
			}
		}
	});
}

// Load template options if pre-selected
{% if selected_template %}
$(document).ready(function() {
	loadTemplateOptions("{{ selected_template }}");
	$('#templateOptions').show();
	$('#segmentsCard').show();
	$('#actionButtons').show();
	if (segmentCount === 0) {
		addSegment(true);
	}
});
{% endif %}
</script>
{% endblock %}
